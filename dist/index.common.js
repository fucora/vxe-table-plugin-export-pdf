"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginExportPDF = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var _jspdf = _interopRequireDefault(require("jspdf"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/* eslint-disable no-unused-vars */

/* eslint-enable no-unused-vars */
var isWin = typeof window !== 'undefined';
var globalOptions = {};
var globalFonts = {};

var _vxetable;

function getFooterCellValue($table, opts, rows, column) {
  var cellValue = _xeUtils["default"].toString(rows[$table.$getColumnIndex(column)]);

  return cellValue;
}

function exportPDF(params) {
  var colWidth = 0;
  var msgKey = 'pdf';
  var fontName = globalOptions.fontName,
      fontUrl = globalOptions.fontUrl;
  var options = params.options,
      columns = params.columns,
      datas = params.datas;
  var showMsg = options.message !== false;
  var $table = params.$table;
  var treeConfig = $table.treeConfig,
      treeOpts = $table.treeOpts;
  var type = options.type,
      filename = options.filename,
      isHeader = options.isHeader,
      isFooter = options.isFooter,
      original = options.original,
      footerFilterMethod = options.footerFilterMethod;
  var footList = [];
  var headers = columns.map(function (column) {
    var title = _xeUtils["default"].toString(original ? column.property : column.getTitle()) || ' ';
    colWidth += column.renderWidth;
    return {
      name: column.id,
      prompt: title,
      width: column.renderWidth
    };
  });
  var rowList = [];
  var colRatio = colWidth / 100;
  headers.forEach(function (column) {
    column.width = Math.floor(column.width / colRatio * 4) - 1;
  });

  if (treeConfig) {
    rowList = datas.map(function (row) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = column.treeNode ? ' '.repeat(row._level * treeOpts.indent / 8) + row[column.id] : row[column.id];
      });
      return item;
    });
  } else {
    rowList = datas;
  }

  if (isFooter) {
    var _$table$getTableData = $table.getTableData(),
        footerData = _$table$getTableData.footerData;

    var footers = footerFilterMethod ? footerData.filter(footerFilterMethod) : footerData;
    footers.forEach(function (rows) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = getFooterCellValue($table, options, rows, column);
      });
      footList.push(item);
    });
  }

  var exportMethod = function exportMethod() {
    /* eslint-disable new-cap */
    var doc = new _jspdf["default"]({
      putOnlyUsedFonts: true,
      orientation: 'landscape'
    }); // 设置字体

    if (fontName && fontUrl) {
      doc.addFont(fontName + '.ttf', fontName, 'normal');
      doc.setFont(fontName, 'normal');
    } // 转换数据


    doc.table(1, 1, rowList.concat(footList), headers, {
      printHeaders: isHeader,
      autoSize: false
    }); // 导出 pdf

    doc.save("".concat(filename, ".").concat(type));

    if (showMsg) {
      _vxetable.modal.close(msgKey);

      _vxetable.modal.message({
        message: _vxetable.t('vxe.table.expSuccess'),
        status: 'success'
      });
    }
  };

  if (showMsg) {
    _vxetable.modal.message({
      id: msgKey,
      message: _vxetable.t('vxe.table.expLoading'),
      status: 'loading',
      duration: -1
    });
  }

  checkFont().then(function () {
    if (showMsg) {
      setTimeout(exportMethod, 1500);
    } else {
      exportMethod();
    }
  });
}

function checkFont() {
  var fontName = globalOptions.fontName,
      fontUrl = globalOptions.fontUrl;

  if (fontName && fontUrl) {
    if (!globalFonts[fontName]) {
      globalFonts[fontName] = new Promise(function (resolve, reject) {
        var fontScript = document.createElement('script');
        fontScript.src = fontUrl;
        fontScript.type = 'text/javascript';
        fontScript.onload = resolve;
        fontScript.onerror = reject;
        document.body.appendChild(fontScript);
      });
      return globalFonts[fontName];
    }
  }

  return Promise.resolve();
}

function handleExportEvent(params) {
  if (params.options.type === 'pdf') {
    exportPDF(params);
    return false;
  }
}

function setup(options) {
  var _Object$assign = Object.assign(globalOptions, options),
      fontName = _Object$assign.fontName,
      fontUrl = _Object$assign.fontUrl;

  if (fontName) {
    if (!fontUrl) {
      throw new Error('The fontUrl cannot be empty.');
    }

    if (isWin && !window.jsPDF) {
      window.jsPDF = _jspdf["default"];
    }
  }
}
/**
 * 基于 vxe-table 表格的增强插件，支持导出 pdf 格式
 */


var VXETablePluginExportPDF = {
  setup: setup,
  install: function install(xtable, options) {
    var interceptor = xtable.interceptor;
    _vxetable = xtable;
    Object.assign(xtable.types, {
      pdf: 0
    });
    interceptor.mixin({
      'event.export': handleExportEvent
    });

    if (options) {
      setup(options);
    }
  }
};
exports.VXETablePluginExportPDF = VXETablePluginExportPDF;

if (isWin && window.VXETable) {
  window.VXETable.use(VXETablePluginExportPDF);
}

var _default = VXETablePluginExportPDF;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImlzV2luIiwid2luZG93IiwiZ2xvYmFsT3B0aW9ucyIsImdsb2JhbEZvbnRzIiwiX3Z4ZXRhYmxlIiwiZ2V0Rm9vdGVyQ2VsbFZhbHVlIiwiJHRhYmxlIiwib3B0cyIsInJvd3MiLCJjb2x1bW4iLCJjZWxsVmFsdWUiLCJYRVV0aWxzIiwidG9TdHJpbmciLCIkZ2V0Q29sdW1uSW5kZXgiLCJleHBvcnRQREYiLCJwYXJhbXMiLCJjb2xXaWR0aCIsIm1zZ0tleSIsImZvbnROYW1lIiwiZm9udFVybCIsIm9wdGlvbnMiLCJjb2x1bW5zIiwiZGF0YXMiLCJzaG93TXNnIiwibWVzc2FnZSIsInRyZWVDb25maWciLCJ0cmVlT3B0cyIsInR5cGUiLCJmaWxlbmFtZSIsImlzSGVhZGVyIiwiaXNGb290ZXIiLCJvcmlnaW5hbCIsImZvb3RlckZpbHRlck1ldGhvZCIsImZvb3RMaXN0IiwiaGVhZGVycyIsIm1hcCIsInRpdGxlIiwicHJvcGVydHkiLCJnZXRUaXRsZSIsInJlbmRlcldpZHRoIiwibmFtZSIsImlkIiwicHJvbXB0Iiwid2lkdGgiLCJyb3dMaXN0IiwiY29sUmF0aW8iLCJmb3JFYWNoIiwiTWF0aCIsImZsb29yIiwicm93IiwiaXRlbSIsInRyZWVOb2RlIiwicmVwZWF0IiwiX2xldmVsIiwiaW5kZW50IiwiZ2V0VGFibGVEYXRhIiwiZm9vdGVyRGF0YSIsImZvb3RlcnMiLCJmaWx0ZXIiLCJwdXNoIiwiZXhwb3J0TWV0aG9kIiwiZG9jIiwianNQREYiLCJwdXRPbmx5VXNlZEZvbnRzIiwib3JpZW50YXRpb24iLCJhZGRGb250Iiwic2V0Rm9udCIsInRhYmxlIiwiY29uY2F0IiwicHJpbnRIZWFkZXJzIiwiYXV0b1NpemUiLCJzYXZlIiwibW9kYWwiLCJjbG9zZSIsInQiLCJzdGF0dXMiLCJkdXJhdGlvbiIsImNoZWNrRm9udCIsInRoZW4iLCJzZXRUaW1lb3V0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmb250U2NyaXB0IiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50Iiwic3JjIiwib25sb2FkIiwib25lcnJvciIsImJvZHkiLCJhcHBlbmRDaGlsZCIsImhhbmRsZUV4cG9ydEV2ZW50Iiwic2V0dXAiLCJPYmplY3QiLCJhc3NpZ24iLCJFcnJvciIsIlZYRVRhYmxlUGx1Z2luRXhwb3J0UERGIiwiaW5zdGFsbCIsInh0YWJsZSIsImludGVyY2VwdG9yIiwidHlwZXMiLCJwZGYiLCJtaXhpbiIsIlZYRVRhYmxlIiwidXNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQ0E7O0FBUUE7Ozs7QUFUQTs7QUFVQTtBQUVBLElBQU1BLEtBQUssR0FBRyxPQUFPQyxNQUFQLEtBQWtCLFdBQWhDO0FBQ0EsSUFBTUMsYUFBYSxHQUFtQyxFQUF0RDtBQUNBLElBQU1DLFdBQVcsR0FBMkIsRUFBNUM7O0FBQ0EsSUFBSUMsU0FBSjs7QUFFQSxTQUFTQyxrQkFBVCxDQUE2QkMsTUFBN0IsRUFBNENDLElBQTVDLEVBQWdFQyxJQUFoRSxFQUE2RUMsTUFBN0UsRUFBaUc7QUFDL0YsTUFBTUMsU0FBUyxHQUFHQyxvQkFBUUMsUUFBUixDQUFpQkosSUFBSSxDQUFDRixNQUFNLENBQUNPLGVBQVAsQ0FBdUJKLE1BQXZCLENBQUQsQ0FBckIsQ0FBbEI7O0FBQ0EsU0FBT0MsU0FBUDtBQUNEOztBQUVELFNBQVNJLFNBQVQsQ0FBb0JDLE1BQXBCLEVBQW1EO0FBQ2pELE1BQUlDLFFBQVEsR0FBRyxDQUFmO0FBQ0EsTUFBTUMsTUFBTSxHQUFHLEtBQWY7QUFGaUQsTUFHekNDLFFBSHlDLEdBR25CaEIsYUFIbUIsQ0FHekNnQixRQUh5QztBQUFBLE1BRy9CQyxPQUgrQixHQUduQmpCLGFBSG1CLENBRy9CaUIsT0FIK0I7QUFBQSxNQUl6Q0MsT0FKeUMsR0FJYkwsTUFKYSxDQUl6Q0ssT0FKeUM7QUFBQSxNQUloQ0MsT0FKZ0MsR0FJYk4sTUFKYSxDQUloQ00sT0FKZ0M7QUFBQSxNQUl2QkMsS0FKdUIsR0FJYlAsTUFKYSxDQUl2Qk8sS0FK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SyxFQUFMQSxLQURxQztBQUVyQ0ssRUFBQUEsT0FGcUMsbUJBRTVCQyxNQUY0QixFQUVIOUUsT0FGRyxFQUVxQztBQUFBLFFBQ2hFK0UsV0FEZ0UsR0FDaERELE1BRGdELENBQ2hFQyxXQURnRTtBQUV4RS9GLElBQUFBLFNBQVMsR0FBRzhGLE1BQVo7QUFDQUwsSUFBQUEsTUFBTSxDQUFDQyxNQUFQLENBQWNJLE1BQU0sQ0FBQ0UsS0FBckIsRUFBNEI7QUFBRUMsTUFBQUEsR0FBRyxFQUFFO0FBQVAsS0FBNUI7QUFDQUYsSUFBQUEsV0FBVyxDQUFDRyxLQUFaLENBQWtCO0FBQ2hCLHNCQUFnQlg7QUFEQSxLQUFsQjs7QUFHQSxRQUFJdkUsT0FBSixFQUFhO0FBQ1h3RSxNQUFBQSxLQUFLLENBQUN4RSxPQUFELENBQUw7QUFDRDtBQUNGO0FBWm9DLENBQWhDOzs7QUFlUCxJQUFJcEIsS0FBSyxJQUFJQyxNQUFNLENBQUNzRyxRQUFwQixFQUE4QjtBQUM1QnRHLEVBQUFBLE1BQU0sQ0FBQ3NHLFFBQVAsQ0FBZ0JDLEdBQWhCLENBQW9CUix1QkFBcEI7QUFDRDs7ZUFFY0EsdUIiLCJmaWxlIjoiaW5kZXguY29tbW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50LWRpc2FibGUgbm8tdW51c2VkLXZhcnMgKi9cclxuaW1wb3J0IFhFVXRpbHMgZnJvbSAneGUtdXRpbHMvbWV0aG9kcy94ZS11dGlscydcclxuaW1wb3J0IHtcclxuICBWWEVUYWJsZSxcclxuICBUYWJsZSxcclxuICBJbnRlcmNlcHRvckV4cG9ydFBhcmFtcyxcclxuICBDb2x1bW5Db25maWcsXHJcbiAgRXhwb3J0T3B0b25zXHJcbn0gZnJvbSAndnhlLXRhYmxlL2xpYi92eGUtdGFibGUnXHJcbmltcG9ydCBqc1BERiBmcm9tICdqc3BkZidcclxuLyogZXNsaW50LWVuYWJsZSBuby11bnVzZWQtdmFycyAqL1xyXG5cclxuY29uc3QgaXNXaW4gPSB0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJ1xyXG5jb25zdCBnbG9iYWxPcHRpb25zOiBWWEVUYWJsZVBsdWdpbkV4cG9ydFBERk9wdGlvbnMgPSB7fVxyXG5jb25zdCBnbG9iYWxGb250czogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9XHJcbmxldCBfdnhldGFibGU6IHR5cGVvZiBWWEVUYWJsZVxyXG5cclxuZnVuY3Rpb24gZ2V0Rm9vdGVyQ2VsbFZhbHVlICgkdGFibGU6IFRhYmxlLCBvcHRzOiBFeHBvcnRPcHRvbnMsIHJvd3M6IGFueVtdLCBjb2x1bW46IENvbHVtbkNvbmZpZykge1xyXG4gIGNvbnN0IGNlbGxWYWx1ZSA9IFhFVXRpbHMudG9TdHJpbmcocm93c1skdGFibGUuJGdldENvbHVtbkluZGV4KGNvbHVtbildKVxyXG4gIHJldHVybiBjZWxsVmFsdWVcclxufVxyXG5cclxuZnVuY3Rpb24gZXhwb3J0UERGIChwYXJhbXM6IEludGVyY2VwdG9yRXhwb3J0UGFyYW1zKSB7XHJcbiAgbGV0IGNvbFdpZHRoID0gMFxyXG4gIGNvbnN0IG1zZ0tleSA9ICdwZGYnXHJcbiAgY29uc3QgeyBmb250TmFtZSwgZm9udFVybCB9ID0gZ2xvYmFsT3B0aW9uc1xyXG4gIGNvbnN0IHsgb3B0aW9ucywgY29sdW1ucywgZGF0YXMgfSA9IHBhcmFtc1xyXG4gIGNvbnN0IHNob3dNc2cgPSBvcHRpb25zLm1lc3NhZ2UgIT09IGZhbHNlXHJcbiAgY29uc3QgJHRhYmxlOiBhbnkgPSBwYXJhbXMuJHRhYmxlXHJcbiAgY29uc3QgeyB0cmVlQ29uZmlnLCB0cmVlT3B0cyB9ID0gJHRhYmxlXHJcbiAgY29uc3QgeyB0eXBlLCBmaWxlbmFtZSwgaXNIZWFkZXIsIGlzRm9vdGVyLCBvcmlnaW5hbCwgZm9vdGVyRmlsdGVyTWV0aG9kIH0gPSBvcHRpb25zXHJcbiAgY29uc3QgZm9vdExpc3Q6IHsgW2tleTogc3RyaW5nXTogYW55IH1bXSA9IFtdXHJcbiAgY29uc3QgaGVhZGVyczogeyBba2V5OiBzdHJpbmddOiBhbnkgfVtdID0gY29sdW1ucy5tYXAoKGNvbHVtbikgPT4ge1xyXG4gICAgY29uc3QgdGl0bGUgPSBYRVV0aWxzLnRvU3RyaW5nKG9yaWdpbmFsID8gY29sdW1uLnByb3BlcnR5IDogY29sdW1uLmdldFRpdGxlKCkpIHx8ICcgJ1xyXG4gICAgY29sV2lkdGggKz0gY29sdW1uLnJlbmRlcldpZHRoXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBuYW1lOiBjb2x1bW4uaWQsXHJcbiAgICAgIHByb21wdDogdGl0bGUsXHJcbiAgICAgIHdpZHRoOiBjb2x1bW4ucmVuZGVyV2lkdGhcclxuICAgIH1cclxuICB9KVxyXG4gIGxldCByb3dMaXN0OiB7IFtrZXk6IHN0cmluZ106IGFueSB9W10gPSBbXVxyXG4gIGNvbnN0IGNvbFJhdGlvID0gY29sV2lkdGggLyAxMDBcclxuICBoZWFkZXJzLmZvckVhY2goKGNvbHVtbikgPT4ge1xyXG4gICAgY29sdW1uLndpZHRoID0gTWF0aC5mbG9vcihjb2x1bW4ud2lkdGggLyBjb2xSYXRpbyAqIDQpIC0gMVxyXG4gIH0pXHJcbiAgaWYgKHRyZWVDb25maWcpIHtcclxuICAgIHJvd0xpc3QgPSBkYXRhcy5tYXAoKHJvdykgPT4ge1xyXG4gICAgICBjb25zdCBpdGVtOiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge31cclxuICAgICAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW4pID0+IHtcclxuICAgICAgICBpdGVtW2NvbHVtbi5pZF0gPSBjb2x1bW4udHJlZU5vZGUgPyAoJyAnLnJlcGVhdChyb3cuX2xldmVsICogdHJlZU9wdHMuaW5kZW50IC8gOCkgKyByb3dbY29sdW1uLmlkXSkgOiByb3dbY29sdW1uLmlkXVxyXG4gICAgICB9KVxyXG4gICAgICByZXR1cm4gaXRlbVxyXG4gICAgfSlcclxuICB9IGVsc2Uge1xyXG4gICAgcm93TGlzdCA9IGRhdGFzXHJcbiAgfVxyXG4gIGlmIChpc0Zvb3Rlcikge1xyXG4gICAgY29uc3QgeyBmb290ZXJEYXRhIH0gPSAkdGFibGUuZ2V0VGFibGVEYXRhKClcclxuICAgIGNvbnN0IGZvb3RlcnMgPSBmb290ZXJGaWx0ZXJNZXRob2QgPyBmb290ZXJEYXRhLmZpbHRlcihmb290ZXJGaWx0ZXJNZXRob2QpIDogZm9vdGVyRGF0YVxyXG4gICAgZm9vdGVycy5mb3JFYWNoKChyb3dzOiBhbnlbXSkgPT4ge1xyXG4gICAgICBjb25zdCBpdGVtOiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge31cclxuICAgICAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW4pID0+IHtcclxuICAgICAgICBpdGVtW2NvbHVtbi5pZF0gPSBnZXRGb290ZXJDZWxsVmFsdWUoJHRhYmxlLCBvcHRpb25zLCByb3dzLCBjb2x1bW4pXHJcbiAgICAgIH0pXHJcbiAgICAgIGZvb3RMaXN0LnB1c2goaXRlbSlcclxuICAgIH0pXHJcbiAgfVxyXG4gIGNvbnN0IGV4cG9ydE1ldGhvZCA9ICgpID0+IHtcclxuICAgIC8qIGVzbGludC1kaXNhYmxlIG5ldy1jYXAgKi9cclxuICAgIGNvbnN0IGRvYyA9IG5ldyBqc1BERih7IHB1dE9ubHlVc2VkRm9udHM6IHRydWUsIG9yaWVudGF0aW9uOiAnbGFuZHNjYXBlJyB9KVxyXG4gICAgLy8g6K6+572u5a2X5L2TXHJcbiAgICBpZiAoZm9udE5hbWUgJiYgZm9udFVybCkge1xyXG4gICAgICBkb2MuYWRkRm9udChmb250TmFtZSArICcudHRmJywgZm9udE5hbWUsICdub3JtYWwnKVxyXG4gICAgICBkb2Muc2V0Rm9udChmb250TmFtZSwgJ25vcm1hbCcpXHJcbiAgICB9XHJcbiAgICAvLyDovazmjaLmlbDmja5cclxuICAgIGRvYy50YWJsZSgxLCAxLCByb3dMaXN0LmNvbmNhdChmb290TGlzdCksIGhlYWRlcnMsIHsgcHJpbnRIZWFkZXJzOiBpc0hlYWRlciwgYXV0b1NpemU6IGZhbHNlIH0pXHJcbiAgICAvLyDlr7zlh7ogcGRmXHJcbiAgICBkb2Muc2F2ZShgJHtmaWxlbmFtZX0uJHt0eXBlfWApXHJcbiAgICBpZiAoc2hvd01zZykge1xyXG4gICAgICBfdnhldGFibGUubW9kYWwuY2xvc2UobXNnS2V5KVxyXG4gICAgICBfdnhldGFibGUubW9kYWwubWVzc2FnZSh7IG1lc3NhZ2U6IF92eGV0YWJsZS50KCd2eGUudGFibGUuZXhwU3VjY2VzcycpLCBzdGF0dXM6ICdzdWNjZXNzJyB9KVxyXG4gICAgfVxyXG4gIH1cclxuICBpZiAoc2hvd01zZykge1xyXG4gICAgX3Z4ZXRhYmxlLm1vZGFsLm1lc3NhZ2UoeyBpZDogbXNnS2V5LCBtZXNzYWdlOiBfdnhldGFibGUudCgndnhlLnRhYmxlLmV4cExvYWRpbmcnKSwgc3RhdHVzOiAnbG9hZGluZycsIGR1cmF0aW9uOiAtMSB9KVxyXG4gIH1cclxuICBjaGVja0ZvbnQoKS50aGVuKCgpID0+IHtcclxuICAgIGlmIChzaG93TXNnKSB7XHJcbiAgICAgIHNldFRpbWVvdXQoZXhwb3J0TWV0aG9kLCAxNTAwKVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgZXhwb3J0TWV0aG9kKClcclxuICAgIH1cclxuICB9KVxyXG59XHJcblxyXG5mdW5jdGlvbiBjaGVja0ZvbnQgKCkge1xyXG4gIGNvbnN0IHsgZm9udE5hbWUsIGZvbnRVcmwgfSA9IGdsb2JhbE9wdGlvbnNcclxuICBpZiAoZm9udE5hbWUgJiYgZm9udFVybCkge1xyXG4gICAgaWYgKCFnbG9iYWxGb250c1tmb250TmFtZV0pIHtcclxuICAgICAgZ2xvYmFsRm9udHNbZm9udE5hbWVdID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGZvbnRTY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKVxyXG4gICAgICAgIGZvbnRTY3JpcHQuc3JjID0gZm9udFVybFxyXG4gICAgICAgIGZvbnRTY3JpcHQudHlwZSA9ICd0ZXh0L2phdmFzY3JpcHQnXHJcbiAgICAgICAgZm9udFNjcmlwdC5vbmxvYWQgPSByZXNvbHZlXHJcbiAgICAgICAgZm9udFNjcmlwdC5vbmVycm9yID0gcmVqZWN0XHJcbiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChmb250U2NyaXB0KVxyXG4gICAgICB9KVxyXG4gICAgICByZXR1cm4gZ2xvYmFsRm9udHNbZm9udE5hbWVdXHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoKVxyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGVFeHBvcnRFdmVudCAocGFyYW1zOiBJbnRlcmNlcHRvckV4cG9ydFBhcmFtcykge1xyXG4gIGlmIChwYXJhbXMub3B0aW9ucy50eXBlID09PSAncGRmJykge1xyXG4gICAgZXhwb3J0UERGKHBhcmFtcylcclxuICAgIHJldHVybiBmYWxzZVxyXG4gIH1cclxufVxyXG5cclxuaW50ZXJmYWNlIFZYRVRhYmxlUGx1Z2luRXhwb3J0UERGT3B0aW9ucyB7XHJcbiAgZm9udE5hbWU/OiAnU291cmNlSGFuU2Fucy1Cb2xkJztcclxuICBmb250VXJsPzogc3RyaW5nO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzZXR1cCAob3B0aW9uczogVlhFVGFibGVQbHVnaW5FeHBvcnRQREZPcHRpb25zKSB7XHJcbiAgY29uc3QgeyBmb250TmFtZSwgZm9udFVybCB9ID0gT2JqZWN0LmFzc2lnbihnbG9iYWxPcHRpb25zLCBvcHRpb25zKVxyXG4gIGlmIChmb250TmFtZSkge1xyXG4gICAgaWYgKCFmb250VXJsKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIGZvbnRVcmwgY2Fubm90IGJlIGVtcHR5LicpXHJcbiAgICB9XHJcbiAgICBpZiAoaXNXaW4gJiYgIXdpbmRvdy5qc1BERikge1xyXG4gICAgICB3aW5kb3cuanNQREYgPSBqc1BERlxyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZGVjbGFyZSBnbG9iYWwge1xyXG4gIGludGVyZmFjZSBXaW5kb3cge1xyXG4gICAganNQREY6IGFueTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDln7rkuo4gdnhlLXRhYmxlIOihqOagvOeahOWinuW8uuaPkuS7tu+8jOaUr+aMgeWvvOWHuiBwZGYg5qC85byPXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgVlhFVGFibGVQbHVnaW5FeHBvcnRQREYgPSB7XHJcbiAgc2V0dXAsXHJcbiAgaW5zdGFsbCAoeHRhYmxlOiB0eXBlb2YgVlhFVGFibGUsIG9wdGlvbnM/OiBWWEVUYWJsZVBsdWdpbkV4cG9ydFBERk9wdGlvbnMpIHtcclxuICAgIGNvbnN0IHsgaW50ZXJjZXB0b3IgfSA9IHh0YWJsZVxyXG4gICAgX3Z4ZXRhYmxlID0geHRhYmxlXHJcbiAgICBPYmplY3QuYXNzaWduKHh0YWJsZS50eXBlcywgeyBwZGY6IDAgfSlcclxuICAgIGludGVyY2VwdG9yLm1peGluKHtcclxuICAgICAgJ2V2ZW50LmV4cG9ydCc6IGhhbmRsZUV4cG9ydEV2ZW50XHJcbiAgICB9KVxyXG4gICAgaWYgKG9wdGlvbnMpIHtcclxuICAgICAgc2V0dXAob3B0aW9ucylcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmlmIChpc1dpbiAmJiB3aW5kb3cuVlhFVGFibGUpIHtcclxuICB3aW5kb3cuVlhFVGFibGUudXNlKFZYRVRhYmxlUGx1Z2luRXhwb3J0UERGKVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBWWEVUYWJsZVBsdWdpbkV4cG9ydFBERlxyXG4iXX0=
