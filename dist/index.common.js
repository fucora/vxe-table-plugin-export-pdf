"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginExportPDF = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var _jspdf = _interopRequireDefault(require("jspdf"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function getSeq($table, row, rowIndex, column, columnIndex) {
  // 在 v3.0 中废弃 startIndex、indexMethod
  var seqOpts = $table.seqOpts;
  var seqMethod = seqOpts.seqMethod || column.indexMethod;
  return seqMethod ? seqMethod({
    row: row,
    rowIndex: rowIndex,
    column: column,
    columnIndex: columnIndex
  }) : (seqOpts.startIndex || $table.startIndex) + rowIndex + 1;
}

function exportPDF(params) {
  var colWidth = 0;
  var $table = params.$table,
      options = params.options,
      columns = params.columns,
      datas = params.datas;
  var treeConfig = $table.treeConfig,
      tableFullData = $table.tableFullData;
  var type = options.type,
      filename = options.filename,
      isHeader = options.isHeader,
      isFooter = options.isFooter,
      original = options.original,
      data = options.data,
      message = options.message,
      footerFilterMethod = options.footerFilterMethod;
  var footList = [];
  var headers = columns.map(function (column) {
    var title = _xeUtils["default"].toString(original ? column.property : column.getTitle()) || ' ';
    colWidth += column.renderWidth;
    return {
      name: column.id,
      prompt: title,
      width: column.renderWidth
    };
  });
  var rowList = [];
  var colRatio = colWidth / 100;
  headers.forEach(function (column) {
    column.width = Math.floor(column.width / colRatio * 4) - 1;
  });

  if (treeConfig) {
    _xeUtils["default"].eachTree(data ? datas : tableFullData, function (row, rowIndex, items, path, parent, nodes) {
      var item = {};
      columns.forEach(function (column, columnIndex) {
        var cellValue;
        var property = column.property;
        var isIndex = column.type === 'seq' || column.type === 'index';

        if (!original || isIndex) {
          cellValue = isIndex ? getSeq($table, row, rowIndex, column, columnIndex) : row[column.id];
        } else {
          cellValue = _xeUtils["default"].get(row, property);
        }

        if (treeConfig && column.treeNode) {
          cellValue = ' '.repeat((nodes.length - 1) * (treeConfig.indent || 16) / 8) + cellValue;
        }

        item[column.id] = _xeUtils["default"].toString(cellValue) || ' ';
      });
      rowList.push(item);
    });
  } else {
    datas.forEach(function (row, rowIndex) {
      var item = {};
      columns.forEach(function (column, columnIndex) {
        var cellValue;
        var property = column.property;
        var isIndex = column.type === 'seq' || column.type === 'index';

        if (!original || isIndex) {
          cellValue = isIndex ? column.indexMethod ? column.indexMethod({
            row: row,
            rowIndex: rowIndex,
            column: column,
            columnIndex: columnIndex
          }) : rowIndex + 1 : row[column.id];
        } else {
          cellValue = _xeUtils["default"].get(row, property);
        }

        item[column.id] = _xeUtils["default"].toString(cellValue) || ' ';
      });
      rowList.push(item);
    });
  }

  if (isFooter) {
    var footerData = $table.footerData;
    var footers = footerFilterMethod ? footerData.filter(footerFilterMethod) : footerData;
    footers.forEach(function (rows) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = _xeUtils["default"].toString(rows[$table.$getColumnIndex(column)]) || ' ';
      });
      footList.push(item);
    });
  } // 转换pdf


  var doc = new _jspdf["default"]({
    putOnlyUsedFonts: true,
    orientation: 'landscape'
  });
  doc.table(1, 1, rowList.concat(footList), headers, {
    printHeaders: isHeader,
    autoSize: false
  });
  doc.save("".concat(filename, ".").concat(type));

  if (message !== false) {
    $table.$XModal.message({
      message: i18n('vxe.table.expSuccess'),
      status: 'success'
    });
  }
}

function handleExportEvent(params) {
  if (params.options.type === 'pdf') {
    exportPDF(params);
    return false;
  }
}
/**
 * 基于 vxe-table 表格的增强插件，支持导出 pdf 格式
 */


var VXETablePluginExportPDF = {
  install: function install(xtable) {
    Object.assign(xtable.types, {
      pdf: 0
    });
    xtable.interceptor.mixin({
      'event.export': handleExportEvent
    });
    VXETablePluginExportPDF.t = xtable.t;
  }
};
exports.VXETablePluginExportPDF = VXETablePluginExportPDF;

function i18n(key) {
  if (VXETablePluginExportPDF.t) {
    return VXETablePluginExportPDF.t(key);
  }
}

if (typeof window !== 'undefined' && window.VXETable) {
  window.VXETable.use(VXETablePluginExportPDF);
}

var _default = VXETablePluginExportPDF;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImdldFNlcSIsIiR0YWJsZSIsInJvdyIsInJvd0luZGV4IiwiY29sdW1uIiwiY29sdW1uSW5kZXgiLCJzZXFPcHRzIiwic2VxTWV0aG9kIiwiaW5kZXhNZXRob2QiLCJzdGFydEluZGV4IiwiZXhwb3J0UERGIiwicGFyYW1zIiwiY29sV2lkdGgiLCJvcHRpb25zIiwiY29sdW1ucyIsImRhdGFzIiwidHJlZUNvbmZpZyIsInRhYmxlRnVsbERhdGEiLCJ0eXBlIiwiZmlsZW5hbWUiLCJpc0hlYWRlciIsImlzRm9vdGVyIiwib3JpZ2luYWwiLCJkYXRhIiwibWVzc2FnZSIsImZvb3RlckZpbHRlck1ldGhvZCIsImZvb3RMaXN0IiwiaGVhZGVycyIsIm1hcCIsInRpdGxlIiwiWEVVdGlscyIsInRvU3RyaW5nIiwicHJvcGVydHkiLCJnZXRUaXRsZSIsInJlbmRlcldpZHRoIiwibmFtZSIsImlkIiwicHJvbXB0Iiwid2lkdGgiLCJyb3dMaXN0IiwiY29sUmF0aW8iLCJmb3JFYWNoIiwiTWF0aCIsImZsb29yIiwiZWFjaFRyZWUiLCJpdGVtcyIsInBhdGgiLCJwYXJlbnQiLCJub2RlcyIsIml0ZW0iLCJjZWxsVmFsdWUiLCJpc0luZGV4IiwiZ2V0IiwidHJlZU5vZGUiLCJyZXBlYXQiLCJsZW5ndGgiLCJpbmRlbnQiLCJwdXNoIiwiZm9vdGVyRGF0YSIsImZvb3RlcnMiLCJmaWx0ZXIiLCJyb3dzIiwiJGdldENvbHVtbkluZGV4IiwiZG9jIiwianNQREYiLCJwdXRPbmx5VXNlZEZvbnRzIiwib3JpZW50YXRpb24iLCJ0YWJsZSIsImNvbmNhdCIsInByaW50SGVhZGVycyIsImF1dG9TaXplIiwic2F2ZSIsIiRYTW9kYWwiLCJpMThuIiwic3RhdHVzIiwiaGFuZGxlRXhwb3J0RXZlbnQiLCJWWEVUYWJsZVBsdWdpbkV4cG9ydFBERiIsImluc3RhbGwiLCJ4dGFibGUiLCJPYmplY3QiLCJhc3NpZ24iLCJ0eXBlcyIsInBkZiIsImlu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QUFDQyxRQUFQLENBQWdCQyxHQUFoQixDQUFvQmIsdUJBQXBCO0FBQ0Q7O2VBRWNBLHVCIiwiZmlsZSI6ImluZGV4LmNvbW1vbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBYRVV0aWxzIGZyb20gJ3hlLXV0aWxzL21ldGhvZHMveGUtdXRpbHMnXHJcbmltcG9ydCBWWEVUYWJsZSBmcm9tICd2eGUtdGFibGUvbGliL3Z4ZS10YWJsZSdcclxuaW1wb3J0IGpzUERGIGZyb20gJ2pzcGRmJ1xyXG5cclxuZnVuY3Rpb24gZ2V0U2VxKCR0YWJsZTogYW55LCByb3c6IGFueSwgcm93SW5kZXg6IG51bWJlciwgY29sdW1uOiBhbnksIGNvbHVtbkluZGV4OiBudW1iZXIpIHtcclxuICAvLyDlnKggdjMuMCDkuK3lup/lvIMgc3RhcnRJbmRleOOAgWluZGV4TWV0aG9kXHJcbiAgbGV0IHNlcU9wdHMgPSAkdGFibGUuc2VxT3B0c1xyXG4gIGxldCBzZXFNZXRob2QgPSBzZXFPcHRzLnNlcU1ldGhvZCB8fCBjb2x1bW4uaW5kZXhNZXRob2RcclxuICByZXR1cm4gc2VxTWV0aG9kID8gc2VxTWV0aG9kKHsgcm93LCByb3dJbmRleCwgY29sdW1uLCBjb2x1bW5JbmRleCB9KSA6ICgoc2VxT3B0cy5zdGFydEluZGV4IHx8ICR0YWJsZS5zdGFydEluZGV4KSArIHJvd0luZGV4ICsgMSlcclxufVxyXG5cclxuZnVuY3Rpb24gZXhwb3J0UERGKHBhcmFtczogYW55KSB7XHJcbiAgbGV0IGNvbFdpZHRoOiBudW1iZXIgPSAwXHJcbiAgY29uc3QgeyAkdGFibGUsIG9wdGlvbnMsIGNvbHVtbnMsIGRhdGFzIH0gPSBwYXJhbXNcclxuICBjb25zdCB7IHRyZWVDb25maWcsIHRhYmxlRnVsbERhdGEgfSA9ICR0YWJsZVxyXG4gIGNvbnN0IHsgdHlwZSwgZmlsZW5hbWUsIGlzSGVhZGVyLCBpc0Zvb3Rlciwgb3JpZ2luYWwsIGRhdGEsIG1lc3NhZ2UsIGZvb3RlckZpbHRlck1ldGhvZCB9ID0gb3B0aW9uc1xyXG4gIGNvbnN0IGZvb3RMaXN0OiBhbnlbXSA9IFtdXHJcbiAgY29uc3QgaGVhZGVyczogYW55W10gPSBjb2x1bW5zLm1hcCgoY29sdW1uOiBhbnkpID0+IHtcclxuICAgIGNvbnN0IHRpdGxlOiBzdHJpbmcgPSBYRVV0aWxzLnRvU3RyaW5nKG9yaWdpbmFsID8gY29sdW1uLnByb3BlcnR5IDogY29sdW1uLmdldFRpdGxlKCkpIHx8ICcgJ1xyXG4gICAgY29sV2lkdGggKz0gY29sdW1uLnJlbmRlcldpZHRoXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBuYW1lOiBjb2x1bW4uaWQsXHJcbiAgICAgIHByb21wdDogdGl0bGUsXHJcbiAgICAgIHdpZHRoOiBjb2x1bW4ucmVuZGVyV2lkdGhcclxuICAgIH1cclxuICB9KVxyXG4gIGxldCByb3dMaXN0OiBhbnlbXSA9IFtdO1xyXG4gIGNvbnN0IGNvbFJhdGlvID0gY29sV2lkdGggLyAxMDBcclxuICBoZWFkZXJzLmZvckVhY2goKGNvbHVtbjogYW55KSA9PiB7XHJcbiAgICBjb2x1bW4ud2lkdGggPSBNYXRoLmZsb29yKGNvbHVtbi53aWR0aCAvIGNvbFJhdGlvICogNCkgLSAxXHJcbiAgfSlcclxuICBpZiAodHJlZUNvbmZpZykge1xyXG4gICAgWEVVdGlscy5lYWNoVHJlZShkYXRhID8gZGF0YXMgOiB0YWJsZUZ1bGxEYXRhLCAocm93OiBhbnksIHJvd0luZGV4OiBudW1iZXIsIGl0ZW1zOiBhbnksIHBhdGg6IGFueVtdLCBwYXJlbnQ6IGFueSwgbm9kZXM6IGFueVtdKSA9PiB7XHJcbiAgICAgIGNvbnN0IGl0ZW06IGFueSA9IHt9XHJcbiAgICAgIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uOiBhbnksIGNvbHVtbkluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgICBsZXQgY2VsbFZhbHVlXHJcbiAgICAgICAgY29uc3QgcHJvcGVydHkgPSBjb2x1bW4ucHJvcGVydHlcclxuICAgICAgICBjb25zdCBpc0luZGV4ID0gY29sdW1uLnR5cGUgPT09ICdzZXEnIHx8IGNvbHVtbi50eXBlID09PSAnaW5kZXgnXHJcbiAgICAgICAgaWYgKCFvcmlnaW5hbCB8fCBpc0luZGV4KSB7XHJcbiAgICAgICAgICBjZWxsVmFsdWUgPSBpc0luZGV4ID8gZ2V0U2VxKCR0YWJsZSwgcm93LCByb3dJbmRleCwgY29sdW1uLCBjb2x1bW5JbmRleCkgOiByb3dbY29sdW1uLmlkXVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBjZWxsVmFsdWUgPSBYRVV0aWxzLmdldChyb3csIHByb3BlcnR5KVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodHJlZUNvbmZpZyAmJiBjb2x1bW4udHJlZU5vZGUpIHtcclxuICAgICAgICAgIGNlbGxWYWx1ZSA9ICcgJy5yZXBlYXQoKG5vZGVzLmxlbmd0aCAtIDEpICogKHRyZWVDb25maWcuaW5kZW50IHx8IDE2KSAvIDgpICsgY2VsbFZhbHVlXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGl0ZW1bY29sdW1uLmlkXSA9IFhFVXRpbHMudG9TdHJpbmcoY2VsbFZhbHVlKSB8fCAnICdcclxuICAgICAgfSlcclxuICAgICAgcm93TGlzdC5wdXNoKGl0ZW0pXHJcbiAgICB9KVxyXG4gIH0gZWxzZSB7XHJcbiAgICBkYXRhcy5mb3JFYWNoKChyb3c6IGFueSwgcm93SW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgICBjb25zdCBpdGVtOiBhbnkgPSB7fVxyXG4gICAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbjogYW55LCBjb2x1bW5JbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgbGV0IGNlbGxWYWx1ZVxyXG4gICAgICAgIGNvbnN0IHByb3BlcnR5ID0gY29sdW1uLnByb3BlcnR5XHJcbiAgICAgICAgY29uc3QgaXNJbmRleCA9IGNvbHVtbi50eXBlID09PSAnc2VxJyB8fCBjb2x1bW4udHlwZSA9PT0gJ2luZGV4J1xyXG4gICAgICAgIGlmICghb3JpZ2luYWwgfHwgaXNJbmRleCkge1xyXG4gICAgICAgICAgY2VsbFZhbHVlID0gaXNJbmRleCA/IChjb2x1bW4uaW5kZXhNZXRob2QgPyBjb2x1bW4uaW5kZXhNZXRob2QoeyByb3csIHJvd0luZGV4LCBjb2x1bW4sIGNvbHVtbkluZGV4IH0pIDogcm93SW5kZXggKyAxKSA6IHJvd1tjb2x1bW4uaWRdXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGNlbGxWYWx1ZSA9IFhFVXRpbHMuZ2V0KHJvdywgcHJvcGVydHkpXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGl0ZW1bY29sdW1uLmlkXSA9IFhFVXRpbHMudG9TdHJpbmcoY2VsbFZhbHVlKSB8fCAnICdcclxuICAgICAgfSlcclxuICAgICAgcm93TGlzdC5wdXNoKGl0ZW0pXHJcbiAgICB9KVxyXG4gIH1cclxuICBpZiAoaXNGb290ZXIpIHtcclxuICAgIGNvbnN0IGZvb3RlckRhdGE6IGFueVtdID0gJHRhYmxlLmZvb3RlckRhdGFcclxuICAgIGNvbnN0IGZvb3RlcnM6IGFueVtdID0gZm9vdGVyRmlsdGVyTWV0aG9kID8gZm9vdGVyRGF0YS5maWx0ZXIoZm9vdGVyRmlsdGVyTWV0aG9kKSA6IGZvb3RlckRhdGFcclxuICAgIGZvb3RlcnMuZm9yRWFjaCgocm93czogYW55W10pID0+IHtcclxuICAgICAgY29uc3QgaXRlbTogYW55ID0ge31cclxuICAgICAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW46IGFueSkgPT4ge1xyXG4gICAgICAgIGl0ZW1bY29sdW1uLmlkXSA9IFhFVXRpbHMudG9TdHJpbmcocm93c1skdGFibGUuJGdldENvbHVtbkluZGV4KGNvbHVtbildKSB8fCAnICdcclxuICAgICAgfSlcclxuICAgICAgZm9vdExpc3QucHVzaChpdGVtKVxyXG4gICAgfSlcclxuICB9XHJcbiAgLy8g6L2s5o2icGRmXHJcbiAgY29uc3QgZG9jID0gbmV3IGpzUERGKHsgcHV0T25seVVzZWRGb250czogdHJ1ZSwgb3JpZW50YXRpb246ICdsYW5kc2NhcGUnIH0pO1xyXG4gIGRvYy50YWJsZSgxLCAxLCByb3dMaXN0LmNvbmNhdChmb290TGlzdCksIGhlYWRlcnMsIHsgcHJpbnRIZWFkZXJzOiBpc0hlYWRlciwgYXV0b1NpemU6IGZhbHNlIH0pO1xyXG4gIGRvYy5zYXZlKGAke2ZpbGVuYW1lfS4ke3R5cGV9YClcclxuICBpZiAobWVzc2FnZSAhPT0gZmFsc2UpIHtcclxuICAgICR0YWJsZS4kWE1vZGFsLm1lc3NhZ2UoeyBtZXNzYWdlOiBpMThuKCd2eGUudGFibGUuZXhwU3VjY2VzcycpLCBzdGF0dXM6ICdzdWNjZXNzJyB9KVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlRXhwb3J0RXZlbnQocGFyYW1zOiBhbnkpIHtcclxuICBpZiAocGFyYW1zLm9wdGlvbnMudHlwZSA9PT0gJ3BkZicpIHtcclxuICAgIGV4cG9ydFBERihwYXJhbXMpXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDln7rkuo4gdnhlLXRhYmxlIOihqOagvOeahOWinuW8uuaPkuS7tu+8jOaUr+aMgeWvvOWHuiBwZGYg5qC85byPXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgVlhFVGFibGVQbHVnaW5FeHBvcnRQREY6IGFueSA9IHtcclxuICBpbnN0YWxsKHh0YWJsZTogdHlwZW9mIFZYRVRhYmxlKSB7XHJcbiAgICBPYmplY3QuYXNzaWduKHh0YWJsZS50eXBlcywgeyBwZGY6IDAgfSlcclxuICAgIHh0YWJsZS5pbnRlcmNlcHRvci5taXhpbih7XHJcbiAgICAgICdldmVudC5leHBvcnQnOiBoYW5kbGVFeHBvcnRFdmVudFxyXG4gICAgfSlcclxuICAgIFZYRVRhYmxlUGx1Z2luRXhwb3J0UERGLnQgPSB4dGFibGUudFxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaTE4bihrZXk6IHN0cmluZykge1xyXG4gIGlmIChWWEVUYWJsZVBsdWdpbkV4cG9ydFBERi50KSB7XHJcbiAgICByZXR1cm4gVlhFVGFibGVQbHVnaW5FeHBvcnRQREYudChrZXkpXHJcbiAgfVxyXG59XHJcblxyXG5pZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LlZYRVRhYmxlKSB7XHJcbiAgd2luZG93LlZYRVRhYmxlLnVzZShWWEVUYWJsZVBsdWdpbkV4cG9ydFBERilcclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgVlhFVGFibGVQbHVnaW5FeHBvcnRQREZcclxuIl19
