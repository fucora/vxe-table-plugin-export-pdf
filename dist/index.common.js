"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginExportPDF = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var _jspdf = _interopRequireDefault(require("jspdf"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/* eslint-disable no-unused-vars */

/* eslint-enable no-unused-vars */
var isWin = typeof window !== 'undefined';
var globalOptions = {};
var globalFonts = {};

var _vxetable;

function getFooterCellValue($table, opts, rows, column) {
  var cellValue = _xeUtils["default"].toString(rows[$table.$getColumnIndex(column)]);

  return cellValue;
}

function exportPDF(params) {
  var colWidth = 0;
  var msgKey = 'pdf';
  var fonts = globalOptions.fonts,
      beforeMethod = globalOptions.beforeMethod;
  var options = params.options,
      columns = params.columns,
      datas = params.datas;
  var showMsg = options.message !== false;
  var $table = params.$table;
  var treeConfig = $table.treeConfig,
      treeOpts = $table.treeOpts;
  var type = options.type,
      filename = options.filename,
      isHeader = options.isHeader,
      isFooter = options.isFooter,
      original = options.original,
      footerFilterMethod = options.footerFilterMethod;
  var footList = [];
  var headers = columns.map(function (column) {
    var title = _xeUtils["default"].toString(original ? column.property : column.getTitle()) || ' ';
    colWidth += column.renderWidth;
    return {
      name: column.id,
      prompt: title,
      width: column.renderWidth
    };
  });
  var rowList = [];
  var colRatio = colWidth / 100;
  headers.forEach(function (column) {
    column.width = Math.floor(column.width / colRatio * 4) - 1;
  });

  if (treeConfig) {
    rowList = datas.map(function (row) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = column.treeNode ? ' '.repeat(row._level * treeOpts.indent / 8) + row[column.id] : row[column.id];
      });
      return item;
    });
  } else {
    rowList = datas;
  }

  if (isFooter) {
    var _$table$getTableData = $table.getTableData(),
        footerData = _$table$getTableData.footerData;

    var footers = footerFilterMethod ? footerData.filter(footerFilterMethod) : footerData;
    footers.forEach(function (rows) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = getFooterCellValue($table, options, rows, column);
      });
      footList.push(item);
    });
  }

  var fontConf;
  var fontName = options.fontName || globalOptions.fontName;

  if (fonts && fontName) {
    fontConf = fonts.find(function (item) {
      return item.fontName === fontName;
    });
  }

  var exportMethod = function exportMethod() {
    /* eslint-disable new-cap */
    var doc = new _jspdf["default"]({
      putOnlyUsedFonts: true,
      orientation: 'landscape'
    }); // 设置字体

    if (fontConf) {
      var _fontConf = fontConf,
          _fontName = _fontConf.fontName,
          _fontConf$fontStyle = _fontConf.fontStyle,
          fontStyle = _fontConf$fontStyle === void 0 ? 'normal' : _fontConf$fontStyle;

      if (globalFonts[_fontName]) {
        doc.addFont(_fontName + '.ttf', _fontName, fontStyle);
        doc.setFont(_fontName, fontStyle);
      }
    } // 导出之前


    if (beforeMethod && beforeMethod({
      $pdf: doc,
      $table: $table,
      options: options,
      columns: columns,
      datas: datas
    }) === false) {
      return;
    } // 转换数据


    doc.table(1, 1, rowList.concat(footList), headers, {
      printHeaders: isHeader,
      autoSize: false
    }); // 导出 pdf

    doc.save("".concat(filename, ".").concat(type));

    if (showMsg) {
      _vxetable.modal.close(msgKey);

      _vxetable.modal.message({
        message: _vxetable.t('vxe.table.expSuccess'),
        status: 'success'
      });
    }
  };

  if (showMsg) {
    _vxetable.modal.message({
      id: msgKey,
      message: _vxetable.t('vxe.table.expLoading'),
      status: 'loading',
      duration: -1
    });
  }

  checkFont(fontConf).then(function () {
    if (showMsg) {
      setTimeout(exportMethod, 1500);
    } else {
      exportMethod();
    }
  });
}

function checkFont(fontConf) {
  if (fontConf) {
    var fontName = fontConf.fontName,
        fontUrl = fontConf.fontUrl;

    if (fontUrl && !globalFonts[fontName]) {
      globalFonts[fontName] = new Promise(function (resolve, reject) {
        var fontScript = document.createElement('script');
        fontScript.src = fontUrl;
        fontScript.type = 'text/javascript';
        fontScript.onload = resolve;
        fontScript.onerror = reject;
        document.body.appendChild(fontScript);
      });
      return globalFonts[fontName];
    }
  }

  return Promise.resolve();
}

function handleExportEvent(params) {
  if (params.options.type === 'pdf') {
    exportPDF(params);
    return false;
  }
}

function setup(options) {
  var _Object$assign = Object.assign(globalOptions, options),
      fonts = _Object$assign.fonts;

  if (fonts) {
    if (isWin && !window.jsPDF) {
      window.jsPDF = _jspdf["default"];
    }
  }
}
/**
 * 基于 vxe-table 表格的增强插件，支持导出 pdf 格式
 */


var VXETablePluginExportPDF = {
  setup: setup,
  install: function install(xtable, options) {
    var interceptor = xtable.interceptor;
    _vxetable = xtable;
    Object.assign(xtable.types, {
      pdf: 0
    });
    interceptor.mixin({
      'event.export': handleExportEvent
    });

    if (options) {
      setup(options);
    }
  }
};
exports.VXETablePluginExportPDF = VXETablePluginExportPDF;

if (isWin && window.VXETable) {
  window.VXETable.use(VXETablePluginExportPDF);
}

var _default = VXETablePluginExportPDF;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImlzV2luIiwid2luZG93IiwiZ2xvYmFsT3B0aW9ucyIsImdsb2JhbEZvbnRzIiwiX3Z4ZXRhYmxlIiwiZ2V0Rm9vdGVyQ2VsbFZhbHVlIiwiJHRhYmxlIiwib3B0cyIsInJvd3MiLCJjb2x1bW4iLCJjZWxsVmFsdWUiLCJYRVV0aWxzIiwidG9TdHJpbmciLCIkZ2V0Q29sdW1uSW5kZXgiLCJleHBvcnRQREYiLCJwYXJhbXMiLCJjb2xXaWR0aCIsIm1zZ0tleSIsImZvbnRzIiwiYmVmb3JlTWV0aG9kIiwib3B0aW9ucyIsImNvbHVtbnMiLCJkYXRhcyIsInNob3dNc2ciLCJtZXNzYWdlIiwidHJlZUNvbmZpZyIsInRyZWVPcHRzIiwidHlwZSIsImZpbGVuYW1lIiwiaXNIZWFkZXIiLCJpc0Zvb3RlciIsIm9yaWdpbmFsIiwiZm9vdGVyRmlsdGVyTWV0aG9kIiwiZm9vdExpc3QiLCJoZWFkZXJzIiwibWFwIiwidGl0bGUiLCJwcm9wZXJ0eSIsImdldFRpdGxlIiwicmVuZGVyV2lkdGgiLCJuYW1lIiwiaWQiLCJwcm9tcHQiLCJ3aWR0aCIsInJvd0xpc3QiLCJjb2xSYXRpbyIsImZvckVhY2giLCJNYXRoIiwiZmxvb3IiLCJyb3ciLCJpdGVtIiwidHJlZU5vZGUiLCJyZXBlYXQiLCJfbGV2ZWwiLCJpbmRlbnQiLCJnZXRUYWJsZURhdGEiLCJmb290ZXJEYXRhIiwiZm9vdGVycyIsImZpbHRlciIsInB1c2giLCJmb250Q29uZiIsImZvbnROYW1lIiwiZmluZCIsImV4cG9ydE1ldGhvZCIsImRvYyIsImpzUERGIiwicHV0T25seVVzZWRGb250cyIsIm9yaWVudGF0aW9uIiwiZm9udFN0eWxlIiwiYWRkRm9udCIsInNldEZvbnQiLCIkcGRmIiwidGFibGUiLCJjb25jYXQiLCJwcmludEhlYWRlcnMiLCJhdXRvU2l6ZSIsInNhdmUiLCJtb2RhbCIsImNsb3NlIiwidCIsInN0YXR1cyIsImR1cmF0aW9uIiwiY2hlY2tGb250IiwidGhlbiIsInNldFRpbWVvdXQiLCJmb250VXJsIiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmb250U2NyaXB0IiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50Iiwic3JjIiwib25sb2FkIiwib25lcnJvciIsImJvZHkiLCJhcHBlbmRDaGlsZCIsImhhbmRsZUV4cG9ydEV2ZW50Iiwic2V0dXAiLCJPYmplY3QiLCJhc3NpZ24iLCJWWEVUYWJsZVBsdWdpbkV4cG9ydFBERiIsImluc3RhbGwiLCJ4dGFibGUiLCJpbnRlcmNlcHRvciIsInR5cGVzIiwicGRmIiwibWl4aW4iLCJWWEVUYWJsZSIsInVzZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBOztBQVFBOzs7O0FBVEE7O0FBVUE7QUFFQSxJQUFNQSxLQUFLLEdBQUcsT0FBT0MsTUFBUCxLQUFrQixXQUFoQztBQUNBLElBQU1DLGFBQWEsR0FBbUMsRUFBdEQ7QUFDQSxJQUFNQyxXQUFXLEdBQTJCLEVBQTVDOztBQUNBLElBQUlDLFNBQUo7O0FBRUEsU0FBU0Msa0JBQVQsQ0FBNkJDLE1BQTdCLEVBQTRDQyxJQUE1QyxFQUFnRUMsSUFBaEUsRUFBNkVDLE1BQTdFLEVBQWlHO0FBQy9GLE1BQU1DLFNBQVMsR0FBR0Msb0JBQVFDLFFBQVIsQ0FBaUJKLElBQUksQ0FBQ0YsTUFBTSxDQUFDTyxlQUFQLENBQXVCSixNQUF2QixDQUFELENBQXJCLENBQWxCOztBQUNBLFNBQU9DLFNBQVA7QUFDRDs7QUFFRCxTQUFTSSxTQUFULENBQW9CQyxNQUFwQixFQUFtRDtBQUNqRCxNQUFJQyxRQUFRLEdBQUcsQ0FBZjtBQUNBLE1BQU1DLE1BQU0sR0FBRyxLQUFmO0FBRmlELE1BR3pDQyxLQUh5QyxHQUdqQmhCLGFBSGlCLENBR3pDZ0IsS0FIeUM7QUFBQSxNQUdsQ0MsWUFIa0MsR0FHakJqQixhQUhpQixDQUdsQ2lCLFlBSGtDO0FBQUEsTUFJekNDLE9BSnlDLEdBSWJMLE1BSmEsQ0FJekNLLE9BSnlDO0FBQUEsTUFJaENDLE9BSmdDLEdBSWJOLE1BSmEs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TUFBQUEsS0FBSyxDQUFDOUUsT0FBRCxDQUFMO0FBQ0Q7QUFDRjtBQVpvQyxDQUFoQzs7O0FBZVAsSUFBSXBCLEtBQUssSUFBSUMsTUFBTSxDQUFDMkcsUUFBcEIsRUFBOEI7QUFDNUIzRyxFQUFBQSxNQUFNLENBQUMyRyxRQUFQLENBQWdCQyxHQUFoQixDQUFvQlIsdUJBQXBCO0FBQ0Q7O2VBRWNBLHVCIiwiZmlsZSI6ImluZGV4LmNvbW1vbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIG5vLXVudXNlZC12YXJzICovXHJcbmltcG9ydCBYRVV0aWxzIGZyb20gJ3hlLXV0aWxzL21ldGhvZHMveGUtdXRpbHMnXHJcbmltcG9ydCB7XHJcbiAgVlhFVGFibGUsXHJcbiAgVGFibGUsXHJcbiAgSW50ZXJjZXB0b3JFeHBvcnRQYXJhbXMsXHJcbiAgQ29sdW1uQ29uZmlnLFxyXG4gIEV4cG9ydE9wdG9uc1xyXG59IGZyb20gJ3Z4ZS10YWJsZS9saWIvdnhlLXRhYmxlJ1xyXG5pbXBvcnQganNQREYgZnJvbSAnanNwZGYnXHJcbi8qIGVzbGludC1lbmFibGUgbm8tdW51c2VkLXZhcnMgKi9cclxuXHJcbmNvbnN0IGlzV2luID0gdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCdcclxuY29uc3QgZ2xvYmFsT3B0aW9uczogVlhFVGFibGVQbHVnaW5FeHBvcnRQREZPcHRpb25zID0ge31cclxuY29uc3QgZ2xvYmFsRm9udHM6IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fVxyXG5sZXQgX3Z4ZXRhYmxlOiB0eXBlb2YgVlhFVGFibGVcclxuXHJcbmZ1bmN0aW9uIGdldEZvb3RlckNlbGxWYWx1ZSAoJHRhYmxlOiBUYWJsZSwgb3B0czogRXhwb3J0T3B0b25zLCByb3dzOiBhbnlbXSwgY29sdW1uOiBDb2x1bW5Db25maWcpIHtcclxuICBjb25zdCBjZWxsVmFsdWUgPSBYRVV0aWxzLnRvU3RyaW5nKHJvd3NbJHRhYmxlLiRnZXRDb2x1bW5JbmRleChjb2x1bW4pXSlcclxuICByZXR1cm4gY2VsbFZhbHVlXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGV4cG9ydFBERiAocGFyYW1zOiBJbnRlcmNlcHRvckV4cG9ydFBhcmFtcykge1xyXG4gIGxldCBjb2xXaWR0aCA9IDBcclxuICBjb25zdCBtc2dLZXkgPSAncGRmJ1xyXG4gIGNvbnN0IHsgZm9udHMsIGJlZm9yZU1ldGhvZCB9ID0gZ2xvYmFsT3B0aW9uc1xyXG4gIGNvbnN0IHsgb3B0aW9ucywgY29sdW1ucywgZGF0YXMgfSA9IHBhcmFtc1xyXG4gIGNvbnN0IHNob3dNc2cgPSBvcHRpb25zLm1lc3NhZ2UgIT09IGZhbHNlXHJcbiAgY29uc3QgJHRhYmxlOiBhbnkgPSBwYXJhbXMuJHRhYmxlXHJcbiAgY29uc3QgeyB0cmVlQ29uZmlnLCB0cmVlT3B0cyB9ID0gJHRhYmxlXHJcbiAgY29uc3QgeyB0eXBlLCBmaWxlbmFtZSwgaXNIZWFkZXIsIGlzRm9vdGVyLCBvcmlnaW5hbCwgZm9vdGVyRmlsdGVyTWV0aG9kIH0gPSBvcHRpb25zXHJcbiAgY29uc3QgZm9vdExpc3Q6IHsgW2tleTogc3RyaW5nXTogYW55IH1bXSA9IFtdXHJcbiAgY29uc3QgaGVhZGVyczogeyBba2V5OiBzdHJpbmddOiBhbnkgfVtdID0gY29sdW1ucy5tYXAoKGNvbHVtbikgPT4ge1xyXG4gICAgY29uc3QgdGl0bGUgPSBYRVV0aWxzLnRvU3RyaW5nKG9yaWdpbmFsID8gY29sdW1uLnByb3BlcnR5IDogY29sdW1uLmdldFRpdGxlKCkpIHx8ICcgJ1xyXG4gICAgY29sV2lkdGggKz0gY29sdW1uLnJlbmRlcldpZHRoXHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBuYW1lOiBjb2x1bW4uaWQsXHJcbiAgICAgIHByb21wdDogdGl0bGUsXHJcbiAgICAgIHdpZHRoOiBjb2x1bW4ucmVuZGVyV2lkdGhcclxuICAgIH1cclxuICB9KVxyXG4gIGxldCByb3dMaXN0OiB7IFtrZXk6IHN0cmluZ106IGFueSB9W10gPSBbXVxyXG4gIGNvbnN0IGNvbFJhdGlvID0gY29sV2lkdGggLyAxMDBcclxuICBoZWFkZXJzLmZvckVhY2goKGNvbHVtbikgPT4ge1xyXG4gICAgY29sdW1uLndpZHRoID0gTWF0aC5mbG9vcihjb2x1bW4ud2lkdGggLyBjb2xSYXRpbyAqIDQpIC0gMVxyXG4gIH0pXHJcbiAgaWYgKHRyZWVDb25maWcpIHtcclxuICAgIHJvd0xpc3QgPSBkYXRhcy5tYXAoKHJvdykgPT4ge1xyXG4gICAgICBjb25zdCBpdGVtOiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge31cclxuICAgICAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW4pID0+IHtcclxuICAgICAgICBpdGVtW2NvbHVtbi5pZF0gPSBjb2x1bW4udHJlZU5vZGUgPyAoJyAnLnJlcGVhdChyb3cuX2xldmVsICogdHJlZU9wdHMuaW5kZW50IC8gOCkgKyByb3dbY29sdW1uLmlkXSkgOiByb3dbY29sdW1uLmlkXVxyXG4gICAgICB9KVxyXG4gICAgICByZXR1cm4gaXRlbVxyXG4gICAgfSlcclxuICB9IGVsc2Uge1xyXG4gICAgcm93TGlzdCA9IGRhdGFzXHJcbiAgfVxyXG4gIGlmIChpc0Zvb3Rlcikge1xyXG4gICAgY29uc3QgeyBmb290ZXJEYXRhIH0gPSAkdGFibGUuZ2V0VGFibGVEYXRhKClcclxuICAgIGNvbnN0IGZvb3RlcnMgPSBmb290ZXJGaWx0ZXJNZXRob2QgPyBmb290ZXJEYXRhLmZpbHRlcihmb290ZXJGaWx0ZXJNZXRob2QpIDogZm9vdGVyRGF0YVxyXG4gICAgZm9vdGVycy5mb3JFYWNoKChyb3dzOiBhbnlbXSkgPT4ge1xyXG4gICAgICBjb25zdCBpdGVtOiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge31cclxuICAgICAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW4pID0+IHtcclxuICAgICAgICBpdGVtW2NvbHVtbi5pZF0gPSBnZXRGb290ZXJDZWxsVmFsdWUoJHRhYmxlLCBvcHRpb25zLCByb3dzLCBjb2x1bW4pXHJcbiAgICAgIH0pXHJcbiAgICAgIGZvb3RMaXN0LnB1c2goaXRlbSlcclxuICAgIH0pXHJcbiAgfVxyXG4gIGxldCBmb250Q29uZjogVlhFVGFibGVQbHVnaW5FeHBvcnRQREZGb250cyB8IG51bGwgfCB1bmRlZmluZWRcclxuICBjb25zdCBmb250TmFtZSA9IG9wdGlvbnMuZm9udE5hbWUgfHwgZ2xvYmFsT3B0aW9ucy5mb250TmFtZVxyXG4gIGlmIChmb250cyAmJiBmb250TmFtZSkge1xyXG4gICAgZm9udENvbmYgPSBmb250cy5maW5kKGl0ZW0gPT4gaXRlbS5mb250TmFtZSA9PT0gZm9udE5hbWUpXHJcbiAgfVxyXG4gIGNvbnN0IGV4cG9ydE1ldGhvZCA9ICgpID0+IHtcclxuICAgIC8qIGVzbGludC1kaXNhYmxlIG5ldy1jYXAgKi9cclxuICAgIGNvbnN0IGRvYyA9IG5ldyBqc1BERih7IHB1dE9ubHlVc2VkRm9udHM6IHRydWUsIG9yaWVudGF0aW9uOiAnbGFuZHNjYXBlJyB9KVxyXG4gICAgLy8g6K6+572u5a2X5L2TXHJcbiAgICBpZiAoZm9udENvbmYpIHtcclxuICAgICAgY29uc3QgeyBmb250TmFtZSwgZm9udFN0eWxlID0gJ25vcm1hbCcgfSA9IGZvbnRDb25mXHJcbiAgICAgIGlmIChnbG9iYWxGb250c1tmb250TmFtZV0pIHtcclxuICAgICAgICBkb2MuYWRkRm9udChmb250TmFtZSArICcudHRmJywgZm9udE5hbWUsIGZvbnRTdHlsZSlcclxuICAgICAgICBkb2Muc2V0Rm9udChmb250TmFtZSwgZm9udFN0eWxlKVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyDlr7zlh7rkuYvliY1cclxuICAgIGlmIChiZWZvcmVNZXRob2QgJiYgYmVmb3JlTWV0aG9kKHsgJHBkZjogZG9jLCAkdGFibGUsIG9wdGlvbnMsIGNvbHVtbnMsIGRhdGFzIH0pID09PSBmYWxzZSkge1xyXG4gICAgICByZXR1cm5cclxuICAgIH1cclxuICAgIC8vIOi9rOaNouaVsOaNrlxyXG4gICAgZG9jLnRhYmxlKDEsIDEsIHJvd0xpc3QuY29uY2F0KGZvb3RMaXN0KSwgaGVhZGVycywgeyBwcmludEhlYWRlcnM6IGlzSGVhZGVyLCBhdXRvU2l6ZTogZmFsc2UgfSlcclxuICAgIC8vIOWvvOWHuiBwZGZcclxuICAgIGRvYy5zYXZlKGAke2ZpbGVuYW1lfS4ke3R5cGV9YClcclxuICAgIGlmIChzaG93TXNnKSB7XHJcbiAgICAgIF92eGV0YWJsZS5tb2RhbC5jbG9zZShtc2dLZXkpXHJcbiAgICAgIF92eGV0YWJsZS5tb2RhbC5tZXNzYWdlKHsgbWVzc2FnZTogX3Z4ZXRhYmxlLnQoJ3Z4ZS50YWJsZS5leHBTdWNjZXNzJyksIHN0YXR1czogJ3N1Y2Nlc3MnIH0pXHJcbiAgICB9XHJcbiAgfVxyXG4gIGlmIChzaG93TXNnKSB7XHJcbiAgICBfdnhldGFibGUubW9kYWwubWVzc2FnZSh7IGlkOiBtc2dLZXksIG1lc3NhZ2U6IF92eGV0YWJsZS50KCd2eGUudGFibGUuZXhwTG9hZGluZycpLCBzdGF0dXM6ICdsb2FkaW5nJywgZHVyYXRpb246IC0xIH0pXHJcbiAgfVxyXG4gIGNoZWNrRm9udChmb250Q29uZikudGhlbigoKSA9PiB7XHJcbiAgICBpZiAoc2hvd01zZykge1xyXG4gICAgICBzZXRUaW1lb3V0KGV4cG9ydE1ldGhvZCwgMTUwMClcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGV4cG9ydE1ldGhvZCgpXHJcbiAgICB9XHJcbiAgfSlcclxufVxyXG5cclxuZnVuY3Rpb24gY2hlY2tGb250IChmb250Q29uZj86IFZYRVRhYmxlUGx1Z2luRXhwb3J0UERGRm9udHMgfCBudWxsIHwgdW5kZWZpbmVkKSB7XHJcbiAgaWYgKGZvbnRDb25mKSB7XHJcbiAgICBjb25zdCB7IGZvbnROYW1lLCBmb250VXJsIH0gPSBmb250Q29uZlxyXG4gICAgaWYgKGZvbnRVcmwgJiYgIWdsb2JhbEZvbnRzW2ZvbnROYW1lXSkge1xyXG4gICAgICBnbG9iYWxGb250c1tmb250TmFtZV0gPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgY29uc3QgZm9udFNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpXHJcbiAgICAgICAgZm9udFNjcmlwdC5zcmMgPSBmb250VXJsXHJcbiAgICAgICAgZm9udFNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCdcclxuICAgICAgICBmb250U2NyaXB0Lm9ubG9hZCA9IHJlc29sdmVcclxuICAgICAgICBmb250U2NyaXB0Lm9uZXJyb3IgPSByZWplY3RcclxuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGZvbnRTY3JpcHQpXHJcbiAgICAgIH0pXHJcbiAgICAgIHJldHVybiBnbG9iYWxGb250c1tmb250TmFtZV1cclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUV4cG9ydEV2ZW50IChwYXJhbXM6IEludGVyY2VwdG9yRXhwb3J0UGFyYW1zKSB7XHJcbiAgaWYgKHBhcmFtcy5vcHRpb25zLnR5cGUgPT09ICdwZGYnKSB7XHJcbiAgICBleHBvcnRQREYocGFyYW1zKVxyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG5pbnRlcmZhY2UgVlhFVGFibGVQbHVnaW5FeHBvcnRQREZGb250cyB7XHJcbiAgZm9udE5hbWU6IHN0cmluZztcclxuICBmb250U3R5bGU/OiAnbm9ybWFsJztcclxuICBmb250VXJsOiBzdHJpbmc7XHJcbn1cclxuXHJcbmludGVyZmFjZSBWWEVUYWJsZVBsdWdpbkV4cG9ydFBERk9wdGlvbnMge1xyXG4gIGZvbnROYW1lPzogc3RyaW5nO1xyXG4gIGZvbnRzPzogVlhFVGFibGVQbHVnaW5FeHBvcnRQREZGb250c1tdO1xyXG4gIGJlZm9yZU1ldGhvZD86IEZ1bmN0aW9uO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzZXR1cCAob3B0aW9uczogVlhFVGFibGVQbHVnaW5FeHBvcnRQREZPcHRpb25zKSB7XHJcbiAgY29uc3QgeyBmb250cyB9ID0gT2JqZWN0LmFzc2lnbihnbG9iYWxPcHRpb25zLCBvcHRpb25zKVxyXG4gIGlmIChmb250cykge1xyXG4gICAgaWYgKGlzV2luICYmICF3aW5kb3cuanNQREYpIHtcclxuICAgICAgd2luZG93LmpzUERGID0ganNQREZcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmRlY2xhcmUgZ2xvYmFsIHtcclxuICBpbnRlcmZhY2UgV2luZG93IHtcclxuICAgIGpzUERGOiBhbnk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog5Z+65LqOIHZ4ZS10YWJsZSDooajmoLznmoTlop7lvLrmj5Lku7bvvIzmlK/mjIHlr7zlh7ogcGRmIOagvOW8j1xyXG4gKi9cclxuZXhwb3J0IGNvbnN0IFZYRVRhYmxlUGx1Z2luRXhwb3J0UERGID0ge1xyXG4gIHNldHVwLFxyXG4gIGluc3RhbGwgKHh0YWJsZTogdHlwZW9mIFZYRVRhYmxlLCBvcHRpb25zPzogVlhFVGFibGVQbHVnaW5FeHBvcnRQREZPcHRpb25zKSB7XHJcbiAgICBjb25zdCB7IGludGVyY2VwdG9yIH0gPSB4dGFibGVcclxuICAgIF92eGV0YWJsZSA9IHh0YWJsZVxyXG4gICAgT2JqZWN0LmFzc2lnbih4dGFibGUudHlwZXMsIHsgcGRmOiAwIH0pXHJcbiAgICBpbnRlcmNlcHRvci5taXhpbih7XHJcbiAgICAgICdldmVudC5leHBvcnQnOiBoYW5kbGVFeHBvcnRFdmVudFxyXG4gICAgfSlcclxuICAgIGlmIChvcHRpb25zKSB7XHJcbiAgICAgIHNldHVwKG9wdGlvbnMpXHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5pZiAoaXNXaW4gJiYgd2luZG93LlZYRVRhYmxlKSB7XHJcbiAgd2luZG93LlZYRVRhYmxlLnVzZShWWEVUYWJsZVBsdWdpbkV4cG9ydFBERilcclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgVlhFVGFibGVQbHVnaW5FeHBvcnRQREZcclxuIl19
