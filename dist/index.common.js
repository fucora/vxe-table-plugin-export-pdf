"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginExportPDF = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var _jspdf = _interopRequireDefault(require("jspdf"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/* eslint-disable no-unused-vars */

/* eslint-enable no-unused-vars */
var isWin = typeof window !== 'undefined';
var globalOptions = {};
var globalFonts = {};

var _vxetable;

function getFooterCellValue($table, opts, rows, column) {
  var cellValue = _xeUtils["default"].toString(rows[$table.$getColumnIndex(column)]);

  return cellValue;
}

function exportPDF(params) {
  var colWidth = 0;
  var msgKey = 'pdf';
  var fontName = globalOptions.fontName,
      fontUrl = globalOptions.fontUrl;
  var options = params.options,
      columns = params.columns,
      datas = params.datas;
  var showMsg = options.message !== false;
  var $table = params.$table;
  var treeConfig = $table.treeConfig,
      treeOpts = $table.treeOpts;
  var type = options.type,
      filename = options.filename,
      isHeader = options.isHeader,
      isFooter = options.isFooter,
      original = options.original,
      footerFilterMethod = options.footerFilterMethod;
  var footList = [];
  var headers = columns.map(function (column) {
    var title = _xeUtils["default"].toString(original ? column.property : column.getTitle()) || ' ';
    colWidth += column.renderWidth;
    return {
      name: column.id,
      prompt: title,
      width: column.renderWidth
    };
  });
  var rowList = [];
  var colRatio = colWidth / 100;
  headers.forEach(function (column) {
    column.width = Math.floor(column.width / colRatio * 4) - 1;
  });

  if (treeConfig) {
    rowList = datas.map(function (row) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = column.treeNode ? ' '.repeat(row._level * treeOpts.indent / 8) + row[column.id] : row[column.id];
      });
      return item;
    });
  } else {
    rowList = datas;
  }

  if (isFooter) {
    var _$table$getTableData = $table.getTableData(),
        footerData = _$table$getTableData.footerData;

    var footers = footerFilterMethod ? footerData.filter(footerFilterMethod) : footerData;
    footers.forEach(function (rows) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = getFooterCellValue($table, options, rows, column);
      });
      footList.push(item);
    });
  }

  var exportMethod = function exportMethod() {
    /* eslint-disable new-cap */
    var doc = new _jspdf["default"]({
      putOnlyUsedFonts: true,
      orientation: 'landscape'
    });

    if (fontName && fontUrl) {
      doc.addFont(fontName + '.ttf', fontName, 'normal');
      doc.setFont(fontName, 'normal');
    }

    doc.table(1, 1, rowList.concat(footList), headers, {
      printHeaders: isHeader,
      autoSize: false
    });
    doc.save("".concat(filename, ".").concat(type));

    if (showMsg) {
      _vxetable.modal.close(msgKey);

      _vxetable.modal.message({
        message: _vxetable.t('vxe.table.expSuccess'),
        status: 'success'
      });
    }
  };

  if (showMsg) {
    _vxetable.modal.message({
      id: msgKey,
      message: _vxetable.t('vxe.table.expLoading'),
      status: 'loading',
      duration: -1
    });
  } // 转换pdf


  checkFont().then(function () {
    if (showMsg) {
      setTimeout(exportMethod, 1000);
    } else {
      exportMethod();
    }
  });
}

function checkFont() {
  var fontName = globalOptions.fontName,
      fontUrl = globalOptions.fontUrl;

  if (fontName && fontUrl) {
    if (!globalFonts[fontName]) {
      globalFonts[fontName] = new Promise(function (resolve, reject) {
        var fontScript = document.createElement('script');
        fontScript.src = fontUrl;
        fontScript.type = 'text/javascript';
        fontScript.onload = resolve;
        fontScript.onerror = reject;
        document.body.appendChild(fontScript);
      });
      return globalFonts[fontName];
    }
  }

  return new Promise(function (resolve) {
    return setTimeout(resolve, 1000);
  });
}

function handleExportEvent(params) {
  if (params.options.type === 'pdf') {
    exportPDF(params);
    return false;
  }
}

function setup(options) {
  var _Object$assign = Object.assign(globalOptions, options),
      fontName = _Object$assign.fontName,
      fontUrl = _Object$assign.fontUrl;

  if (fontName) {
    if (!fontUrl) {
      throw new Error('The fontUrl cannot be empty.');
    }

    if (isWin && !window.jsPDF) {
      window.jsPDF = _jspdf["default"];
    }
  }
}
/**
 * 基于 vxe-table 表格的增强插件，支持导出 pdf 格式
 */


var VXETablePluginExportPDF = {
  setup: setup,
  install: function install(xtable, options) {
    var interceptor = xtable.interceptor;
    _vxetable = xtable;
    Object.assign(xtable.types, {
      pdf: 0
    });
    interceptor.mixin({
      'event.export': handleExportEvent
    });

    if (options) {
      setup(options);
    }
  }
};
exports.VXETablePluginExportPDF = VXETablePluginExportPDF;

if (isWin && window.VXETable) {
  window.VXETable.use(VXETablePluginExportPDF);
}

var _default = VXETablePluginExportPDF;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImlzV2luIiwid2luZG93IiwiZ2xvYmFsT3B0aW9ucyIsImdsb2JhbEZvbnRzIiwiX3Z4ZXRhYmxlIiwiZ2V0Rm9vdGVyQ2VsbFZhbHVlIiwiJHRhYmxlIiwib3B0cyIsInJvd3MiLCJjb2x1bW4iLCJjZWxsVmFsdWUiLCJYRVV0aWxzIiwidG9TdHJpbmciLCIkZ2V0Q29sdW1uSW5kZXgiLCJleHBvcnRQREYiLCJwYXJhbXMiLCJjb2xXaWR0aCIsIm1zZ0tleSIsImZvbnROYW1lIiwiZm9udFVybCIsIm9wdGlvbnMiLCJjb2x1bW5zIiwiZGF0YXMiLCJzaG93TXNnIiwibWVzc2FnZSIsInRyZWVDb25maWciLCJ0cmVlT3B0cyIsInR5cGUiLCJmaWxlbmFtZSIsImlzSGVhZGVyIiwiaXNGb290ZXIiLCJvcmlnaW5hbCIsImZvb3RlckZpbHRlck1ldGhvZCIsImZvb3RMaXN0IiwiaGVhZGVycyIsIm1hcCIsInRpdGxlIiwicHJvcGVydHkiLCJnZXRUaXRsZSIsInJlbmRlcldpZHRoIiwibmFtZSIsImlkIiwicHJvbXB0Iiwid2lkdGgiLCJyb3dMaXN0IiwiY29sUmF0aW8iLCJmb3JFYWNoIiwiTWF0aCIsImZsb29yIiwicm93IiwiaXRlbSIsInRyZWVOb2RlIiwicmVwZWF0IiwiX2xldmVsIiwiaW5kZW50IiwiZ2V0VGFibGVEYXRhIiwiZm9vdGVyRGF0YSIsImZvb3RlcnMiLCJmaWx0ZXIiLCJwdXNoIiwiZXhwb3J0TWV0aG9kIiwiZG9jIiwianNQREYiLCJwdXRPbmx5VXNlZEZvbnRzIiwib3JpZW50YXRpb24iLCJhZGRGb250Iiwic2V0Rm9udCIsInRhYmxlIiwiY29uY2F0IiwicHJpbnRIZWFkZXJzIiwiYXV0b1NpemUiLCJzYXZlIiwibW9kYWwiLCJjbG9zZSIsInQiLCJzdGF0dXMiLCJkdXJhdGlvbiIsImNoZWNrRm9udCIsInRoZW4iLCJzZXRUaW1lb3V0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJmb250U2NyaXB0IiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50Iiwic3JjIiwib25sb2FkIiwib25lcnJvciIsImJvZHkiLCJhcHBlbmRDaGlsZCIsImhhbmRsZUV4cG9ydEV2ZW50Iiwic2V0dXAiLCJPYmplY3QiLCJhc3NpZ24iLCJFcnJvciIsIlZYRVRhYmxlUGx1Z2luRXhwb3J0UERGIiwiaW5zdGFsbCIsInh0YWJsZSIsImludGVyY2VwdG9yIiwidHlwZXMiLCJwZGYiLCJtaXhpbiIsIlZYRVRhYmxlIiwidXNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQ0E7O0FBUUE7Ozs7QUFUQTs7QUFVQTtBQUVBLElBQU1BLEtBQUssR0FBRyxPQUFPQyxNQUFQLEtBQWtCLFdBQWhDO0FBQ0EsSUFBTUMsYUFBYSxHQUFtQyxFQUF0RDtBQUNBLElBQU1DLFdBQVcsR0FBMkIsRUFBNUM7O0FBQ0EsSUFBSUMsU0FBSjs7QUFFQSxTQUFTQyxrQkFBVCxDQUE2QkMsTUFBN0IsRUFBNENDLElBQTVDLEVBQWdFQyxJQUFoRSxFQUE2RUMsTUFBN0UsRUFBaUc7QUFDL0YsTUFBTUMsU0FBUyxHQUFHQyxvQkFBUUMsUUFBUixDQUFpQkosSUFBSSxDQUFDRixNQUFNLENBQUNPLGVBQVAsQ0FBdUJKLE1BQXZCLENBQUQsQ0FBckIsQ0FBbEI7O0FBQ0EsU0FBT0MsU0FBUDtBQUNEOztBQUVELFNBQVNJLFNBQVQsQ0FBb0JDLE1BQXBCLEVBQW1EO0FBQ2pELE1BQUlDLFFBQVEsR0FBRyxDQUFmO0FBQ0EsTUFBTUMsTUFBTSxHQUFHLEtBQWY7QUFGaUQsTUFHekNDLFFBSHlDLEdBR25CaEIsYUFIbUIsQ0FHekNnQixRQUh5QztBQUFBLE1BRy9CQyxPQUgrQixHQUduQmpCLGFBSG1CLENBRy9CaUIsT0FIK0I7QUFBQSxNQUl6Q0MsT0FKeUMsR0FJYkwsTUFKYSxDQUl6Q0ssT0FKeUM7QUFBQSxNQUloQ0MsT0FKZ0MsR0FJYk4sTUFKYSxDQUloQ00sT0FKZ0M7QUFBQSxNQUl2QkMsS0FKdUIsR0FJYlAsTUFKYSxDQUl2Qk8sS0FK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R08sSUFBTWtDLHVCQUF1QixHQUFHO0FBQ3JDSixFQUFBQSxLQUFLLEVBQUxBLEtBRHFDO0FBRXJDSyxFQUFBQSxPQUZxQyxtQkFFNUJDLE1BRjRCLEVBRUg5RSxPQUZHLEVBRXFDO0FBQUEsUUFDaEUrRSxXQURnRSxHQUNoREQsTUFEZ0QsQ0FDaEVDLFdBRGdFO0FBRXhFL0YsSUFBQUEsU0FBUyxHQUFHOEYsTUFBWjtBQUNBTCxJQUFBQSxNQUFNLENBQUNDLE1BQVAsQ0FBY0ksTUFBTSxDQUFDRSxLQUFyQixFQUE0QjtBQUFFQyxNQUFBQSxHQUFHLEVBQUU7QUFBUCxLQUE1QjtBQUNBRixJQUFBQSxXQUFXLENBQUNHLEtBQVosQ0FBa0I7QUFDaEIsc0JBQWdCWDtBQURBLEtBQWxCOztBQUdBLFFBQUl2RSxPQUFKLEVBQWE7QUFDWHdFLE1BQUFBLEtBQUssQ0FBQ3hFLE9BQUQsQ0FBTDtBQUNEO0FBQ0Y7QUFab0MsQ0FBaEM7OztBQWVQLElBQUlwQixLQUFLLElBQUlDLE1BQU0sQ0FBQ3NHLFFBQXBCLEVBQThCO0FBQzVCdEcsRUFBQUEsTUFBTSxDQUFDc0csUUFBUCxDQUFnQkMsR0FBaEIsQ0FBb0JSLHVCQUFwQjtBQUNEOztlQUVjQSx1QiIsImZpbGUiOiJpbmRleC5jb21tb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby11bnVzZWQtdmFycyAqL1xyXG5pbXBvcnQgWEVVdGlscyBmcm9tICd4ZS11dGlscy9tZXRob2RzL3hlLXV0aWxzJ1xyXG5pbXBvcnQge1xyXG4gIFZYRVRhYmxlLFxyXG4gIFRhYmxlLFxyXG4gIEludGVyY2VwdG9yRXhwb3J0UGFyYW1zLFxyXG4gIENvbHVtbkNvbmZpZyxcclxuICBFeHBvcnRPcHRvbnNcclxufSBmcm9tICd2eGUtdGFibGUvbGliL3Z4ZS10YWJsZSdcclxuaW1wb3J0IGpzUERGIGZyb20gJ2pzcGRmJ1xyXG4vKiBlc2xpbnQtZW5hYmxlIG5vLXVudXNlZC12YXJzICovXHJcblxyXG5jb25zdCBpc1dpbiA9IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnXHJcbmNvbnN0IGdsb2JhbE9wdGlvbnM6IFZYRVRhYmxlUGx1Z2luRXhwb3J0UERGT3B0aW9ucyA9IHt9XHJcbmNvbnN0IGdsb2JhbEZvbnRzOiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge31cclxubGV0IF92eGV0YWJsZTogdHlwZW9mIFZYRVRhYmxlXHJcblxyXG5mdW5jdGlvbiBnZXRGb290ZXJDZWxsVmFsdWUgKCR0YWJsZTogVGFibGUsIG9wdHM6IEV4cG9ydE9wdG9ucywgcm93czogYW55W10sIGNvbHVtbjogQ29sdW1uQ29uZmlnKSB7XHJcbiAgY29uc3QgY2VsbFZhbHVlID0gWEVVdGlscy50b1N0cmluZyhyb3dzWyR0YWJsZS4kZ2V0Q29sdW1uSW5kZXgoY29sdW1uKV0pXHJcbiAgcmV0dXJuIGNlbGxWYWx1ZVxyXG59XHJcblxyXG5mdW5jdGlvbiBleHBvcnRQREYgKHBhcmFtczogSW50ZXJjZXB0b3JFeHBvcnRQYXJhbXMpIHtcclxuICBsZXQgY29sV2lkdGggPSAwXHJcbiAgY29uc3QgbXNnS2V5ID0gJ3BkZidcclxuICBjb25zdCB7IGZvbnROYW1lLCBmb250VXJsIH0gPSBnbG9iYWxPcHRpb25zXHJcbiAgY29uc3QgeyBvcHRpb25zLCBjb2x1bW5zLCBkYXRhcyB9ID0gcGFyYW1zXHJcbiAgY29uc3Qgc2hvd01zZyA9IG9wdGlvbnMubWVzc2FnZSAhPT0gZmFsc2VcclxuICBjb25zdCAkdGFibGU6IGFueSA9IHBhcmFtcy4kdGFibGVcclxuICBjb25zdCB7IHRyZWVDb25maWcsIHRyZWVPcHRzIH0gPSAkdGFibGVcclxuICBjb25zdCB7IHR5cGUsIGZpbGVuYW1lLCBpc0hlYWRlciwgaXNGb290ZXIsIG9yaWdpbmFsLCBmb290ZXJGaWx0ZXJNZXRob2QgfSA9IG9wdGlvbnNcclxuICBjb25zdCBmb290TGlzdDogeyBba2V5OiBzdHJpbmddOiBhbnkgfVtdID0gW11cclxuICBjb25zdCBoZWFkZXJzOiB7IFtrZXk6IHN0cmluZ106IGFueSB9W10gPSBjb2x1bW5zLm1hcCgoY29sdW1uKSA9PiB7XHJcbiAgICBjb25zdCB0aXRsZSA9IFhFVXRpbHMudG9TdHJpbmcob3JpZ2luYWwgPyBjb2x1bW4ucHJvcGVydHkgOiBjb2x1bW4uZ2V0VGl0bGUoKSkgfHwgJyAnXHJcbiAgICBjb2xXaWR0aCArPSBjb2x1bW4ucmVuZGVyV2lkdGhcclxuICAgIHJldHVybiB7XHJcbiAgICAgIG5hbWU6IGNvbHVtbi5pZCxcclxuICAgICAgcHJvbXB0OiB0aXRsZSxcclxuICAgICAgd2lkdGg6IGNvbHVtbi5yZW5kZXJXaWR0aFxyXG4gICAgfVxyXG4gIH0pXHJcbiAgbGV0IHJvd0xpc3Q6IHsgW2tleTogc3RyaW5nXTogYW55IH1bXSA9IFtdXHJcbiAgY29uc3QgY29sUmF0aW8gPSBjb2xXaWR0aCAvIDEwMFxyXG4gIGhlYWRlcnMuZm9yRWFjaCgoY29sdW1uKSA9PiB7XHJcbiAgICBjb2x1bW4ud2lkdGggPSBNYXRoLmZsb29yKGNvbHVtbi53aWR0aCAvIGNvbFJhdGlvICogNCkgLSAxXHJcbiAgfSlcclxuICBpZiAodHJlZUNvbmZpZykge1xyXG4gICAgcm93TGlzdCA9IGRhdGFzLm1hcCgocm93KSA9PiB7XHJcbiAgICAgIGNvbnN0IGl0ZW06IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fVxyXG4gICAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbikgPT4ge1xyXG4gICAgICAgIGl0ZW1bY29sdW1uLmlkXSA9IGNvbHVtbi50cmVlTm9kZSA/ICgnICcucmVwZWF0KHJvdy5fbGV2ZWwgKiB0cmVlT3B0cy5pbmRlbnQgLyA4KSArIHJvd1tjb2x1bW4uaWRdKSA6IHJvd1tjb2x1bW4uaWRdXHJcbiAgICAgIH0pXHJcbiAgICAgIHJldHVybiBpdGVtXHJcbiAgICB9KVxyXG4gIH0gZWxzZSB7XHJcbiAgICByb3dMaXN0ID0gZGF0YXNcclxuICB9XHJcbiAgaWYgKGlzRm9vdGVyKSB7XHJcbiAgICBjb25zdCB7IGZvb3RlckRhdGEgfSA9ICR0YWJsZS5nZXRUYWJsZURhdGEoKVxyXG4gICAgY29uc3QgZm9vdGVycyA9IGZvb3RlckZpbHRlck1ldGhvZCA/IGZvb3RlckRhdGEuZmlsdGVyKGZvb3RlckZpbHRlck1ldGhvZCkgOiBmb290ZXJEYXRhXHJcbiAgICBmb290ZXJzLmZvckVhY2goKHJvd3M6IGFueVtdKSA9PiB7XHJcbiAgICAgIGNvbnN0IGl0ZW06IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fVxyXG4gICAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbikgPT4ge1xyXG4gICAgICAgIGl0ZW1bY29sdW1uLmlkXSA9IGdldEZvb3RlckNlbGxWYWx1ZSgkdGFibGUsIG9wdGlvbnMsIHJvd3MsIGNvbHVtbilcclxuICAgICAgfSlcclxuICAgICAgZm9vdExpc3QucHVzaChpdGVtKVxyXG4gICAgfSlcclxuICB9XHJcbiAgY29uc3QgZXhwb3J0TWV0aG9kID0gKCkgPT4ge1xyXG4gICAgLyogZXNsaW50LWRpc2FibGUgbmV3LWNhcCAqL1xyXG4gICAgY29uc3QgZG9jID0gbmV3IGpzUERGKHsgcHV0T25seVVzZWRGb250czogdHJ1ZSwgb3JpZW50YXRpb246ICdsYW5kc2NhcGUnIH0pXHJcbiAgICBpZiAoZm9udE5hbWUgJiYgZm9udFVybCkge1xyXG4gICAgICBkb2MuYWRkRm9udChmb250TmFtZSArICcudHRmJywgZm9udE5hbWUsICdub3JtYWwnKVxyXG4gICAgICBkb2Muc2V0Rm9udChmb250TmFtZSwgJ25vcm1hbCcpXHJcbiAgICB9XHJcbiAgICBkb2MudGFibGUoMSwgMSwgcm93TGlzdC5jb25jYXQoZm9vdExpc3QpLCBoZWFkZXJzLCB7IHByaW50SGVhZGVyczogaXNIZWFkZXIsIGF1dG9TaXplOiBmYWxzZSB9KVxyXG4gICAgZG9jLnNhdmUoYCR7ZmlsZW5hbWV9LiR7dHlwZX1gKVxyXG4gICAgaWYgKHNob3dNc2cpIHtcclxuICAgICAgX3Z4ZXRhYmxlLm1vZGFsLmNsb3NlKG1zZ0tleSlcclxuICAgICAgX3Z4ZXRhYmxlLm1vZGFsLm1lc3NhZ2UoeyBtZXNzYWdlOiBfdnhldGFibGUudCgndnhlLnRhYmxlLmV4cFN1Y2Nlc3MnKSwgc3RhdHVzOiAnc3VjY2VzcycgfSlcclxuICAgIH1cclxuICB9XHJcbiAgaWYgKHNob3dNc2cpIHtcclxuICAgIF92eGV0YWJsZS5tb2RhbC5tZXNzYWdlKHsgaWQ6IG1zZ0tleSwgbWVzc2FnZTogX3Z4ZXRhYmxlLnQoJ3Z4ZS50YWJsZS5leHBMb2FkaW5nJyksIHN0YXR1czogJ2xvYWRpbmcnLCBkdXJhdGlvbjogLTEgfSlcclxuICB9XHJcbiAgLy8g6L2s5o2icGRmXHJcbiAgY2hlY2tGb250KCkudGhlbigoKSA9PiB7XHJcbiAgICBpZiAoc2hvd01zZykge1xyXG4gICAgICBzZXRUaW1lb3V0KGV4cG9ydE1ldGhvZCwgMTAwMClcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGV4cG9ydE1ldGhvZCgpXHJcbiAgICB9XHJcbiAgfSlcclxufVxyXG5cclxuZnVuY3Rpb24gY2hlY2tGb250ICgpIHtcclxuICBjb25zdCB7IGZvbnROYW1lLCBmb250VXJsIH0gPSBnbG9iYWxPcHRpb25zXHJcbiAgaWYgKGZvbnROYW1lICYmIGZvbnRVcmwpIHtcclxuICAgIGlmICghZ2xvYmFsRm9udHNbZm9udE5hbWVdKSB7XHJcbiAgICAgIGdsb2JhbEZvbnRzW2ZvbnROYW1lXSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICBjb25zdCBmb250U2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0JylcclxuICAgICAgICBmb250U2NyaXB0LnNyYyA9IGZvbnRVcmxcclxuICAgICAgICBmb250U2NyaXB0LnR5cGUgPSAndGV4dC9qYXZhc2NyaXB0J1xyXG4gICAgICAgIGZvbnRTY3JpcHQub25sb2FkID0gcmVzb2x2ZVxyXG4gICAgICAgIGZvbnRTY3JpcHQub25lcnJvciA9IHJlamVjdFxyXG4gICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZm9udFNjcmlwdClcclxuICAgICAgfSlcclxuICAgICAgcmV0dXJuIGdsb2JhbEZvbnRzW2ZvbnROYW1lXVxyXG4gICAgfVxyXG4gIH1cclxuICByZXR1cm4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwMDApKVxyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGVFeHBvcnRFdmVudCAocGFyYW1zOiBJbnRlcmNlcHRvckV4cG9ydFBhcmFtcykge1xyXG4gIGlmIChwYXJhbXMub3B0aW9ucy50eXBlID09PSAncGRmJykge1xyXG4gICAgZXhwb3J0UERGKHBhcmFtcylcclxuICAgIHJldHVybiBmYWxzZVxyXG4gIH1cclxufVxyXG5cclxuaW50ZXJmYWNlIFZYRVRhYmxlUGx1Z2luRXhwb3J0UERGT3B0aW9ucyB7XHJcbiAgZm9udE5hbWU/OiAnU291cmNlSGFuU2Fucy1Cb2xkJztcclxuICBmb250VXJsPzogc3RyaW5nO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzZXR1cCAob3B0aW9uczogVlhFVGFibGVQbHVnaW5FeHBvcnRQREZPcHRpb25zKSB7XHJcbiAgY29uc3QgeyBmb250TmFtZSwgZm9udFVybCB9ID0gT2JqZWN0LmFzc2lnbihnbG9iYWxPcHRpb25zLCBvcHRpb25zKVxyXG4gIGlmIChmb250TmFtZSkge1xyXG4gICAgaWYgKCFmb250VXJsKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIGZvbnRVcmwgY2Fubm90IGJlIGVtcHR5LicpXHJcbiAgICB9XHJcbiAgICBpZiAoaXNXaW4gJiYgIXdpbmRvdy5qc1BERikge1xyXG4gICAgICB3aW5kb3cuanNQREYgPSBqc1BERlxyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZGVjbGFyZSBnbG9iYWwge1xyXG4gIGludGVyZmFjZSBXaW5kb3cge1xyXG4gICAganNQREY6IGFueTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDln7rkuo4gdnhlLXRhYmxlIOihqOagvOeahOWinuW8uuaPkuS7tu+8jOaUr+aMgeWvvOWHuiBwZGYg5qC85byPXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgVlhFVGFibGVQbHVnaW5FeHBvcnRQREYgPSB7XHJcbiAgc2V0dXAsXHJcbiAgaW5zdGFsbCAoeHRhYmxlOiB0eXBlb2YgVlhFVGFibGUsIG9wdGlvbnM/OiBWWEVUYWJsZVBsdWdpbkV4cG9ydFBERk9wdGlvbnMpIHtcclxuICAgIGNvbnN0IHsgaW50ZXJjZXB0b3IgfSA9IHh0YWJsZVxyXG4gICAgX3Z4ZXRhYmxlID0geHRhYmxlXHJcbiAgICBPYmplY3QuYXNzaWduKHh0YWJsZS50eXBlcywgeyBwZGY6IDAgfSlcclxuICAgIGludGVyY2VwdG9yLm1peGluKHtcclxuICAgICAgJ2V2ZW50LmV4cG9ydCc6IGhhbmRsZUV4cG9ydEV2ZW50XHJcbiAgICB9KVxyXG4gICAgaWYgKG9wdGlvbnMpIHtcclxuICAgICAgc2V0dXAob3B0aW9ucylcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmlmIChpc1dpbiAmJiB3aW5kb3cuVlhFVGFibGUpIHtcclxuICB3aW5kb3cuVlhFVGFibGUudXNlKFZYRVRhYmxlUGx1Z2luRXhwb3J0UERGKVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBWWEVUYWJsZVBsdWdpbkV4cG9ydFBERlxyXG4iXX0=
