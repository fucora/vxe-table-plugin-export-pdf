"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginExportPDF = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var _jspdf = _interopRequireDefault(require("jspdf"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/* eslint-disable no-unused-vars */

/* eslint-enable no-unused-vars */
var isWin = typeof window !== 'undefined';
var globalOptions = {};
var globalFonts = {};

var _vxetable;

function getFooterCellValue($table, opts, rows, column) {
  var cellValue = _xeUtils["default"].toString(rows[$table.$getColumnIndex(column)]);

  return cellValue;
}

function exportPDF(params) {
  var colWidth = 0;
  var msgKey = 'pdf';
  var fontName = globalOptions.fontName,
      _globalOptions$fontSt = globalOptions.fontStyle,
      fontStyle = _globalOptions$fontSt === void 0 ? 'normal' : _globalOptions$fontSt,
      beforeMethod = globalOptions.beforeMethod;
  var options = params.options,
      columns = params.columns,
      datas = params.datas;
  var showMsg = options.message !== false;
  var $table = params.$table;
  var treeConfig = $table.treeConfig,
      treeOpts = $table.treeOpts;
  var type = options.type,
      filename = options.filename,
      isHeader = options.isHeader,
      isFooter = options.isFooter,
      original = options.original,
      footerFilterMethod = options.footerFilterMethod;
  var footList = [];
  var headers = columns.map(function (column) {
    var title = _xeUtils["default"].toString(original ? column.property : column.getTitle()) || ' ';
    colWidth += column.renderWidth;
    return {
      name: column.id,
      prompt: title,
      width: column.renderWidth
    };
  });
  var rowList = [];
  var colRatio = colWidth / 100;
  headers.forEach(function (column) {
    column.width = Math.floor(column.width / colRatio * 4) - 1;
  });

  if (treeConfig) {
    rowList = datas.map(function (row) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = column.treeNode ? ' '.repeat(row._level * treeOpts.indent / 8) + row[column.id] : row[column.id];
      });
      return item;
    });
  } else {
    rowList = datas;
  }

  if (isFooter) {
    var _$table$getTableData = $table.getTableData(),
        footerData = _$table$getTableData.footerData;

    var footers = footerFilterMethod ? footerData.filter(footerFilterMethod) : footerData;
    footers.forEach(function (rows) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = getFooterCellValue($table, options, rows, column);
      });
      footList.push(item);
    });
  }

  var exportMethod = function exportMethod() {
    /* eslint-disable new-cap */
    var doc = new _jspdf["default"]({
      putOnlyUsedFonts: true,
      orientation: 'landscape'
    }); // 设置字体

    if (fontName && globalFonts[fontName]) {
      doc.addFont(fontName + '.ttf', fontName, fontStyle);
      doc.setFont(fontName, fontStyle);
    } // 导出之前


    if (beforeMethod && beforeMethod({
      $pdf: doc,
      $table: $table,
      options: options,
      columns: columns,
      datas: datas
    }) === false) {
      return;
    } // 转换数据


    doc.table(1, 1, rowList.concat(footList), headers, {
      printHeaders: isHeader,
      autoSize: false
    }); // 导出 pdf

    doc.save("".concat(filename, ".").concat(type));

    if (showMsg) {
      _vxetable.modal.close(msgKey);

      _vxetable.modal.message({
        message: _vxetable.t('vxe.table.expSuccess'),
        status: 'success'
      });
    }
  };

  if (showMsg) {
    _vxetable.modal.message({
      id: msgKey,
      message: _vxetable.t('vxe.table.expLoading'),
      status: 'loading',
      duration: -1
    });
  }

  checkFont().then(function () {
    if (showMsg) {
      setTimeout(exportMethod, 1500);
    } else {
      exportMethod();
    }
  });
}

function checkFont() {
  var fontName = globalOptions.fontName,
      fontUrl = globalOptions.fontUrl;

  if (fontName && fontUrl) {
    if (!globalFonts[fontName]) {
      globalFonts[fontName] = new Promise(function (resolve, reject) {
        var fontScript = document.createElement('script');
        fontScript.src = fontUrl;
        fontScript.type = 'text/javascript';
        fontScript.onload = resolve;
        fontScript.onerror = reject;
        document.body.appendChild(fontScript);
      });
      return globalFonts[fontName];
    }
  }

  return Promise.resolve();
}

function handleExportEvent(params) {
  if (params.options.type === 'pdf') {
    exportPDF(params);
    return false;
  }
}

function setup(options) {
  var _Object$assign = Object.assign(globalOptions, options),
      fontName = _Object$assign.fontName,
      fontUrl = _Object$assign.fontUrl;

  if (fontName) {
    if (!fontUrl) {
      throw new Error('The fontUrl cannot be empty.');
    }

    if (isWin && !window.jsPDF) {
      window.jsPDF = _jspdf["default"];
    }
  }
}
/**
 * 基于 vxe-table 表格的增强插件，支持导出 pdf 格式
 */


var VXETablePluginExportPDF = {
  setup: setup,
  install: function install(xtable, options) {
    var interceptor = xtable.interceptor;
    _vxetable = xtable;
    Object.assign(xtable.types, {
      pdf: 0
    });
    interceptor.mixin({
      'event.export': handleExportEvent
    });

    if (options) {
      setup(options);
    }
  }
};
exports.VXETablePluginExportPDF = VXETablePluginExportPDF;

if (isWin && window.VXETable) {
  window.VXETable.use(VXETablePluginExportPDF);
}

var _default = VXETablePluginExportPDF;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImlzV2luIiwid2luZG93IiwiZ2xvYmFsT3B0aW9ucyIsImdsb2JhbEZvbnRzIiwiX3Z4ZXRhYmxlIiwiZ2V0Rm9vdGVyQ2VsbFZhbHVlIiwiJHRhYmxlIiwib3B0cyIsInJvd3MiLCJjb2x1bW4iLCJjZWxsVmFsdWUiLCJYRVV0aWxzIiwidG9TdHJpbmciLCIkZ2V0Q29sdW1uSW5kZXgiLCJleHBvcnRQREYiLCJwYXJhbXMiLCJjb2xXaWR0aCIsIm1zZ0tleSIsImZvbnROYW1lIiwiZm9udFN0eWxlIiwiYmVmb3JlTWV0aG9kIiwib3B0aW9ucyIsImNvbHVtbnMiLCJkYXRhcyIsInNob3dNc2ciLCJtZXNzYWdlIiwidHJlZUNvbmZpZyIsInRyZWVPcHRzIiwidHlwZSIsImZpbGVuYW1lIiwiaXNIZWFkZXIiLCJpc0Zvb3RlciIsIm9yaWdpbmFsIiwiZm9vdGVyRmlsdGVyTWV0aG9kIiwiZm9vdExpc3QiLCJoZWFkZXJzIiwibWFwIiwidGl0bGUiLCJwcm9wZXJ0eSIsImdldFRpdGxlIiwicmVuZGVyV2lkdGgiLCJuYW1lIiwiaWQiLCJwcm9tcHQiLCJ3aWR0aCIsInJvd0xpc3QiLCJjb2xSYXRpbyIsImZvckVhY2giLCJNYXRoIiwiZmxvb3IiLCJyb3ciLCJpdGVtIiwidHJlZU5vZGUiLCJyZXBlYXQiLCJfbGV2ZWwiLCJpbmRlbnQiLCJnZXRUYWJsZURhdGEiLCJmb290ZXJEYXRhIiwiZm9vdGVycyIsImZpbHRlciIsInB1c2giLCJleHBvcnRNZXRob2QiLCJkb2MiLCJqc1BERiIsInB1dE9ubHlVc2VkRm9udHMiLCJvcmllbnRhdGlvbiIsImFkZEZvbnQiLCJzZXRGb250IiwiJHBkZiIsInRhYmxlIiwiY29uY2F0IiwicHJpbnRIZWFkZXJzIiwiYXV0b1NpemUiLCJzYXZlIiwibW9kYWwiLCJjbG9zZSIsInQiLCJzdGF0dXMiLCJkdXJhdGlvbiIsImNoZWNrRm9udCIsInRoZW4iLCJzZXRUaW1lb3V0IiwiZm9udFVybCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwiZm9udFNjcmlwdCIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudCIsInNyYyIsIm9ubG9hZCIsIm9uZXJyb3IiLCJib2R5IiwiYXBwZW5kQ2hpbGQiLCJoYW5kbGVFeHBvcnRFdmVudCIsInNldHVwIiwiT2JqZWN0IiwiYXNzaWduIiwiRXJyb3IiLCJWWEVUYWJsZVBsdWdpbkV4cG9ydFBERiIsImluc3RhbGwiLCJ4dGFibGUiLCJpbnRlcmNlcHRvciIsInR5cGVzIiwicGRmIiwibWl4aW4iLCJWWEVUYWJsZSIsInVzZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBOztBQVFBOzs7O0FBVEE7O0FBVUE7QUFFQSxJQUFNQSxLQUFLLEdBQUcsT0FBT0MsTUFBUCxLQUFrQixXQUFoQztBQUNBLElBQU1DLGFBQWEsR0FBbUMsRUFBdEQ7QUFDQSxJQUFNQyxXQUFXLEdBQTJCLEVBQTVDOztBQUNBLElBQUlDLFNBQUo7O0FBRUEsU0FBU0Msa0JBQVQsQ0FBNkJDLE1BQTdCLEVBQTRDQyxJQUE1QyxFQUFnRUMsSUFBaEUsRUFBNkVDLE1BQTdFLEVBQWlHO0FBQy9GLE1BQU1DLFNBQVMsR0FBR0Msb0JBQVFDLFFBQVIsQ0FBaUJKLElBQUksQ0FBQ0YsTUFBTSxDQUFDTyxlQUFQLENBQXVCSixNQUF2QixDQUFELENBQXJCLENBQWxCOztBQUNBLFNBQU9DLFNBQVA7QUFDRDs7QUFFRCxTQUFTSSxTQUFULENBQW9CQyxNQUFwQixFQUFtRDtBQUNqRCxNQUFJQyxRQUFRLEdBQUcsQ0FBZjtBQUNBLE1BQU1DLE1BQU0sR0FBRyxLQUFmO0FBRmlELE1BR3pDQyxRQUh5QyxHQUdRaEIsYUFIUixDQUd6Q2dCLFFBSHlDO0FBQUEsOEJBR1FoQixhQUhSLENBRy9CaUIsU0FIK0I7QUFBQSxNQUcvQkEsU0FIK0Isc0NBR25CLFFBSG1CO0FBQUEsTUFHVEMsWUFIUyxHQUdRbEIsYUFIUixDQUdUa0IsWUFIUztBQUFBLE1BSXpDQyxPQUp5QyxHQUliTixNQUphLENBSXpD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by11bnVzZWQtdmFycyAqL1xyXG5pbXBvcnQgWEVVdGlscyBmcm9tICd4ZS11dGlscy9tZXRob2RzL3hlLXV0aWxzJ1xyXG5pbXBvcnQge1xyXG4gIFZYRVRhYmxlLFxyXG4gIFRhYmxlLFxyXG4gIEludGVyY2VwdG9yRXhwb3J0UGFyYW1zLFxyXG4gIENvbHVtbkNvbmZpZyxcclxuICBFeHBvcnRPcHRvbnNcclxufSBmcm9tICd2eGUtdGFibGUvbGliL3Z4ZS10YWJsZSdcclxuaW1wb3J0IGpzUERGIGZyb20gJ2pzcGRmJ1xyXG4vKiBlc2xpbnQtZW5hYmxlIG5vLXVudXNlZC12YXJzICovXHJcblxyXG5jb25zdCBpc1dpbiA9IHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnXHJcbmNvbnN0IGdsb2JhbE9wdGlvbnM6IFZYRVRhYmxlUGx1Z2luRXhwb3J0UERGT3B0aW9ucyA9IHt9XHJcbmNvbnN0IGdsb2JhbEZvbnRzOiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge31cclxubGV0IF92eGV0YWJsZTogdHlwZW9mIFZYRVRhYmxlXHJcblxyXG5mdW5jdGlvbiBnZXRGb290ZXJDZWxsVmFsdWUgKCR0YWJsZTogVGFibGUsIG9wdHM6IEV4cG9ydE9wdG9ucywgcm93czogYW55W10sIGNvbHVtbjogQ29sdW1uQ29uZmlnKSB7XHJcbiAgY29uc3QgY2VsbFZhbHVlID0gWEVVdGlscy50b1N0cmluZyhyb3dzWyR0YWJsZS4kZ2V0Q29sdW1uSW5kZXgoY29sdW1uKV0pXHJcbiAgcmV0dXJuIGNlbGxWYWx1ZVxyXG59XHJcblxyXG5mdW5jdGlvbiBleHBvcnRQREYgKHBhcmFtczogSW50ZXJjZXB0b3JFeHBvcnRQYXJhbXMpIHtcclxuICBsZXQgY29sV2lkdGggPSAwXHJcbiAgY29uc3QgbXNnS2V5ID0gJ3BkZidcclxuICBjb25zdCB7IGZvbnROYW1lLCBmb250U3R5bGUgPSAnbm9ybWFsJywgYmVmb3JlTWV0aG9kIH0gPSBnbG9iYWxPcHRpb25zXHJcbiAgY29uc3QgeyBvcHRpb25zLCBjb2x1bW5zLCBkYXRhcyB9ID0gcGFyYW1zXHJcbiAgY29uc3Qgc2hvd01zZyA9IG9wdGlvbnMubWVzc2FnZSAhPT0gZmFsc2VcclxuICBjb25zdCAkdGFibGU6IGFueSA9IHBhcmFtcy4kdGFibGVcclxuICBjb25zdCB7IHRyZWVDb25maWcsIHRyZWVPcHRzIH0gPSAkdGFibGVcclxuICBjb25zdCB7IHR5cGUsIGZpbGVuYW1lLCBpc0hlYWRlciwgaXNGb290ZXIsIG9yaWdpbmFsLCBmb290ZXJGaWx0ZXJNZXRob2QgfSA9IG9wdGlvbnNcclxuICBjb25zdCBmb290TGlzdDogeyBba2V5OiBzdHJpbmddOiBhbnkgfVtdID0gW11cclxuICBjb25zdCBoZWFkZXJzOiB7IFtrZXk6IHN0cmluZ106IGFueSB9W10gPSBjb2x1bW5zLm1hcCgoY29sdW1uKSA9PiB7XHJcbiAgICBjb25zdCB0aXRsZSA9IFhFVXRpbHMudG9TdHJpbmcob3JpZ2luYWwgPyBjb2x1bW4ucHJvcGVydHkgOiBjb2x1bW4uZ2V0VGl0bGUoKSkgfHwgJyAnXHJcbiAgICBjb2xXaWR0aCArPSBjb2x1bW4ucmVuZGVyV2lkdGhcclxuICAgIHJldHVybiB7XHJcbiAgICAgIG5hbWU6IGNvbHVtbi5pZCxcclxuICAgICAgcHJvbXB0OiB0aXRsZSxcclxuICAgICAgd2lkdGg6IGNvbHVtbi5yZW5kZXJXaWR0aFxyXG4gICAgfVxyXG4gIH0pXHJcbiAgbGV0IHJvd0xpc3Q6IHsgW2tleTogc3RyaW5nXTogYW55IH1bXSA9IFtdXHJcbiAgY29uc3QgY29sUmF0aW8gPSBjb2xXaWR0aCAvIDEwMFxyXG4gIGhlYWRlcnMuZm9yRWFjaCgoY29sdW1uKSA9PiB7XHJcbiAgICBjb2x1bW4ud2lkdGggPSBNYXRoLmZsb29yKGNvbHVtbi53aWR0aCAvIGNvbFJhdGlvICogNCkgLSAxXHJcbiAgfSlcclxuICBpZiAodHJlZUNvbmZpZykge1xyXG4gICAgcm93TGlzdCA9IGRhdGFzLm1hcCgocm93KSA9PiB7XHJcbiAgICAgIGNvbnN0IGl0ZW06IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fVxyXG4gICAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbikgPT4ge1xyXG4gICAgICAgIGl0ZW1bY29sdW1uLmlkXSA9IGNvbHVtbi50cmVlTm9kZSA/ICgnICcucmVwZWF0KHJvdy5fbGV2ZWwgKiB0cmVlT3B0cy5pbmRlbnQgLyA4KSArIHJvd1tjb2x1bW4uaWRdKSA6IHJvd1tjb2x1bW4uaWRdXHJcbiAgICAgIH0pXHJcbiAgICAgIHJldHVybiBpdGVtXHJcbiAgICB9KVxyXG4gIH0gZWxzZSB7XHJcbiAgICByb3dMaXN0ID0gZGF0YXNcclxuICB9XHJcbiAgaWYgKGlzRm9vdGVyKSB7XHJcbiAgICBjb25zdCB7IGZvb3RlckRhdGEgfSA9ICR0YWJsZS5nZXRUYWJsZURhdGEoKVxyXG4gICAgY29uc3QgZm9vdGVycyA9IGZvb3RlckZpbHRlck1ldGhvZCA/IGZvb3RlckRhdGEuZmlsdGVyKGZvb3RlckZpbHRlck1ldGhvZCkgOiBmb290ZXJEYXRhXHJcbiAgICBmb290ZXJzLmZvckVhY2goKHJvd3M6IGFueVtdKSA9PiB7XHJcbiAgICAgIGNvbnN0IGl0ZW06IHsgW2tleTogc3RyaW5nXTogYW55IH0gPSB7fVxyXG4gICAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbikgPT4ge1xyXG4gICAgICAgIGl0ZW1bY29sdW1uLmlkXSA9IGdldEZvb3RlckNlbGxWYWx1ZSgkdGFibGUsIG9wdGlvbnMsIHJvd3MsIGNvbHVtbilcclxuICAgICAgfSlcclxuICAgICAgZm9vdExpc3QucHVzaChpdGVtKVxyXG4gICAgfSlcclxuICB9XHJcbiAgY29uc3QgZXhwb3J0TWV0aG9kID0gKCkgPT4ge1xyXG4gICAgLyogZXNsaW50LWRpc2FibGUgbmV3LWNhcCAqL1xyXG4gICAgY29uc3QgZG9jID0gbmV3IGpzUERGKHsgcHV0T25seVVzZWRGb250czogdHJ1ZSwgb3JpZW50YXRpb246ICdsYW5kc2NhcGUnIH0pXHJcbiAgICAvLyDorr7nva7lrZfkvZNcclxuICAgIGlmIChmb250TmFtZSAmJiBnbG9iYWxGb250c1tmb250TmFtZV0pIHtcclxuICAgICAgZG9jLmFkZEZvbnQoZm9udE5hbWUgKyAnLnR0ZicsIGZvbnROYW1lLCBmb250U3R5bGUpXHJcbiAgICAgIGRvYy5zZXRGb250KGZvbnROYW1lLCBmb250U3R5bGUpXHJcbiAgICB9XHJcbiAgICAvLyDlr7zlh7rkuYvliY1cclxuICAgIGlmIChiZWZvcmVNZXRob2QgJiYgYmVmb3JlTWV0aG9kKHsgJHBkZjogZG9jLCAkdGFibGUsIG9wdGlvbnMsIGNvbHVtbnMsIGRhdGFzIH0pID09PSBmYWxzZSkge1xyXG4gICAgICByZXR1cm5cclxuICAgIH1cclxuICAgIC8vIOi9rOaNouaVsOaNrlxyXG4gICAgZG9jLnRhYmxlKDEsIDEsIHJvd0xpc3QuY29uY2F0KGZvb3RMaXN0KSwgaGVhZGVycywgeyBwcmludEhlYWRlcnM6IGlzSGVhZGVyLCBhdXRvU2l6ZTogZmFsc2UgfSlcclxuICAgIC8vIOWvvOWHuiBwZGZcclxuICAgIGRvYy5zYXZlKGAke2ZpbGVuYW1lfS4ke3R5cGV9YClcclxuICAgIGlmIChzaG93TXNnKSB7XHJcbiAgICAgIF92eGV0YWJsZS5tb2RhbC5jbG9zZShtc2dLZXkpXHJcbiAgICAgIF92eGV0YWJsZS5tb2RhbC5tZXNzYWdlKHsgbWVzc2FnZTogX3Z4ZXRhYmxlLnQoJ3Z4ZS50YWJsZS5leHBTdWNjZXNzJyksIHN0YXR1czogJ3N1Y2Nlc3MnIH0pXHJcbiAgICB9XHJcbiAgfVxyXG4gIGlmIChzaG93TXNnKSB7XHJcbiAgICBfdnhldGFibGUubW9kYWwubWVzc2FnZSh7IGlkOiBtc2dLZXksIG1lc3NhZ2U6IF92eGV0YWJsZS50KCd2eGUudGFibGUuZXhwTG9hZGluZycpLCBzdGF0dXM6ICdsb2FkaW5nJywgZHVyYXRpb246IC0xIH0pXHJcbiAgfVxyXG4gIGNoZWNrRm9udCgpLnRoZW4oKCkgPT4ge1xyXG4gICAgaWYgKHNob3dNc2cpIHtcclxuICAgICAgc2V0VGltZW91dChleHBvcnRNZXRob2QsIDE1MDApXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBleHBvcnRNZXRob2QoKVxyXG4gICAgfVxyXG4gIH0pXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNoZWNrRm9udCAoKSB7XHJcbiAgY29uc3QgeyBmb250TmFtZSwgZm9udFVybCB9ID0gZ2xvYmFsT3B0aW9uc1xyXG4gIGlmIChmb250TmFtZSAmJiBmb250VXJsKSB7XHJcbiAgICBpZiAoIWdsb2JhbEZvbnRzW2ZvbnROYW1lXSkge1xyXG4gICAgICBnbG9iYWxGb250c1tmb250TmFtZV0gPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgY29uc3QgZm9udFNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpXHJcbiAgICAgICAgZm9udFNjcmlwdC5zcmMgPSBmb250VXJsXHJcbiAgICAgICAgZm9udFNjcmlwdC50eXBlID0gJ3RleHQvamF2YXNjcmlwdCdcclxuICAgICAgICBmb250U2NyaXB0Lm9ubG9hZCA9IHJlc29sdmVcclxuICAgICAgICBmb250U2NyaXB0Lm9uZXJyb3IgPSByZWplY3RcclxuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGZvbnRTY3JpcHQpXHJcbiAgICAgIH0pXHJcbiAgICAgIHJldHVybiBnbG9iYWxGb250c1tmb250TmFtZV1cclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUV4cG9ydEV2ZW50IChwYXJhbXM6IEludGVyY2VwdG9yRXhwb3J0UGFyYW1zKSB7XHJcbiAgaWYgKHBhcmFtcy5vcHRpb25zLnR5cGUgPT09ICdwZGYnKSB7XHJcbiAgICBleHBvcnRQREYocGFyYW1zKVxyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG5pbnRlcmZhY2UgVlhFVGFibGVQbHVnaW5FeHBvcnRQREZPcHRpb25zIHtcclxuICBmb250TmFtZT86ICdTb3VyY2VIYW5TYW5zLUJvbGQnO1xyXG4gIGZvbnRTdHlsZT86ICdub3JtYWwnO1xyXG4gIGZvbnRVcmw/OiBzdHJpbmc7XHJcbiAgYmVmb3JlTWV0aG9kPzogRnVuY3Rpb247XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNldHVwIChvcHRpb25zOiBWWEVUYWJsZVBsdWdpbkV4cG9ydFBERk9wdGlvbnMpIHtcclxuICBjb25zdCB7IGZvbnROYW1lLCBmb250VXJsIH0gPSBPYmplY3QuYXNzaWduKGdsb2JhbE9wdGlvbnMsIG9wdGlvbnMpXHJcbiAgaWYgKGZvbnROYW1lKSB7XHJcbiAgICBpZiAoIWZvbnRVcmwpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgZm9udFVybCBjYW5ub3QgYmUgZW1wdHkuJylcclxuICAgIH1cclxuICAgIGlmIChpc1dpbiAmJiAhd2luZG93LmpzUERGKSB7XHJcbiAgICAgIHdpbmRvdy5qc1BERiA9IGpzUERGXHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5kZWNsYXJlIGdsb2JhbCB7XHJcbiAgaW50ZXJmYWNlIFdpbmRvdyB7XHJcbiAgICBqc1BERjogYW55O1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOWfuuS6jiB2eGUtdGFibGUg6KGo5qC855qE5aKe5by65o+S5Lu277yM5pSv5oyB5a+85Ye6IHBkZiDmoLzlvI9cclxuICovXHJcbmV4cG9ydCBjb25zdCBWWEVUYWJsZVBsdWdpbkV4cG9ydFBERiA9IHtcclxuICBzZXR1cCxcclxuICBpbnN0YWxsICh4dGFibGU6IHR5cGVvZiBWWEVUYWJsZSwgb3B0aW9ucz86IFZYRVRhYmxlUGx1Z2luRXhwb3J0UERGT3B0aW9ucykge1xyXG4gICAgY29uc3QgeyBpbnRlcmNlcHRvciB9ID0geHRhYmxlXHJcbiAgICBfdnhldGFibGUgPSB4dGFibGVcclxuICAgIE9iamVjdC5hc3NpZ24oeHRhYmxlLnR5cGVzLCB7IHBkZjogMCB9KVxyXG4gICAgaW50ZXJjZXB0b3IubWl4aW4oe1xyXG4gICAgICAnZXZlbnQuZXhwb3J0JzogaGFuZGxlRXhwb3J0RXZlbnRcclxuICAgIH0pXHJcbiAgICBpZiAob3B0aW9ucykge1xyXG4gICAgICBzZXR1cChvcHRpb25zKVxyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuaWYgKGlzV2luICYmIHdpbmRvdy5WWEVUYWJsZSkge1xyXG4gIHdpbmRvdy5WWEVUYWJsZS51c2UoVlhFVGFibGVQbHVnaW5FeHBvcnRQREYpXHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IFZYRVRhYmxlUGx1Z2luRXhwb3J0UERGXHJcbiJdfQ==
