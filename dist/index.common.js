"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginExportPDF = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var _jspdf = _interopRequireDefault(require("jspdf"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function exportPDF(params) {
  var colWidth = 0;
  var $table = params.$table,
      options = params.options,
      columns = params.columns,
      datas = params.datas;
  var treeConfig = $table.treeConfig,
      tableFullData = $table.tableFullData;
  var type = options.type,
      filename = options.filename,
      isHeader = options.isHeader,
      isFooter = options.isFooter,
      original = options.original,
      data = options.data,
      message = options.message,
      footerFilterMethod = options.footerFilterMethod;
  var colHead = {};
  var footList = [];
  var headers = columns.map(function (column) {
    var title = _xeUtils["default"].toString(original ? column.property : column.getTitle()) || ' ';
    colWidth += column.renderWidth;

    if (isHeader) {
      colHead[column.id] = title;
    }

    return {
      name: column.id,
      prompt: title,
      width: column.renderWidth
    };
  });
  var rowList = [];
  var colRatio = colWidth / 100;
  headers.forEach(function (column) {
    column.width = Math.floor(column.width / colRatio * 4) - 1;
  });

  if (treeConfig) {
    _xeUtils["default"].eachTree(data ? datas : tableFullData, function (row, rowIndex, items, path, parent, nodes) {
      var item = {};
      columns.forEach(function (column, columnIndex) {
        var cellValue;
        var property = column.property;
        var isIndex = column.type === 'index';

        if (!original || isIndex) {
          cellValue = isIndex ? column.indexMethod ? column.indexMethod({
            row: row,
            rowIndex: rowIndex,
            column: column,
            columnIndex: columnIndex
          }) : rowIndex + 1 : row[column.id];
        } else {
          cellValue = _xeUtils["default"].get(row, property);
        }

        if (treeConfig && column.treeNode) {
          cellValue = ' '.repeat((nodes.length - 1) * (treeConfig.indent || 16) / 8) + cellValue;
        }

        item[column.id] = _xeUtils["default"].toString(cellValue) || ' ';
      });
      rowList.push(item);
    });
  } else {
    datas.forEach(function (row, rowIndex) {
      var item = {};
      columns.forEach(function (column, columnIndex) {
        var cellValue;
        var property = column.property;
        var isIndex = column.type === 'index';

        if (!original || isIndex) {
          cellValue = isIndex ? column.indexMethod ? column.indexMethod({
            row: row,
            rowIndex: rowIndex,
            column: column,
            columnIndex: columnIndex
          }) : rowIndex + 1 : row[column.id];
        } else {
          cellValue = _xeUtils["default"].get(row, property);
        }

        item[column.id] = _xeUtils["default"].toString(cellValue) || ' ';
      });
      rowList.push(item);
    });
  }

  if (isFooter) {
    var footerData = $table.footerData;
    var footers = footerFilterMethod ? footerData.filter(footerFilterMethod) : footerData;
    footers.forEach(function (rows) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = _xeUtils["default"].toString(rows[$table.getColumnIndex(column)]) || ' ';
      });
      footList.push(item);
    });
  } // 转换pdf


  var doc = new _jspdf["default"]({
    putOnlyUsedFonts: true,
    orientation: 'landscape'
  });
  doc.table(1, 1, (isHeader ? [colHead] : []).concat(rowList).concat(footList), headers, {
    printHeaders: false,
    autoSize: false
  });
  doc.save("".concat(filename, ".").concat(type));

  if (message !== false) {
    $table.$XModal.message({
      message: i18n('vxe.table.expSuccess'),
      status: 'success'
    });
  }
}

function handleExportEvent(params) {
  if (params.options.type === 'pdf') {
    exportPDF(params);
    return false;
  }
}
/**
 * 基于 vxe-table 表格的增强插件，支持导出 pdf 格式
 */


var VXETablePluginExportPDF = {
  install: function install(xtable) {
    Object.assign(xtable.types, {
      pdf: 0
    });
    xtable.interceptor.mixin({
      'event.export': handleExportEvent
    });
    VXETablePluginExportPDF.t = xtable.t;
  }
};
exports.VXETablePluginExportPDF = VXETablePluginExportPDF;

function i18n(key) {
  if (VXETablePluginExportPDF.t) {
    return VXETablePluginExportPDF.t(key);
  }
}

if (typeof window !== 'undefined' && window.VXETable) {
  window.VXETable.use(VXETablePluginExportPDF);
}

var _default = VXETablePluginExportPDF;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImV4cG9ydFBERiIsInBhcmFtcyIsImNvbFdpZHRoIiwiJHRhYmxlIiwib3B0aW9ucyIsImNvbHVtbnMiLCJkYXRhcyIsInRyZWVDb25maWciLCJ0YWJsZUZ1bGxEYXRhIiwidHlwZSIsImZpbGVuYW1lIiwiaXNIZWFkZXIiLCJpc0Zvb3RlciIsIm9yaWdpbmFsIiwiZGF0YSIsIm1lc3NhZ2UiLCJmb290ZXJGaWx0ZXJNZXRob2QiLCJjb2xIZWFkIiwiZm9vdExpc3QiLCJoZWFkZXJzIiwibWFwIiwiY29sdW1uIiwidGl0bGUiLCJYRVV0aWxzIiwidG9TdHJpbmciLCJwcm9wZXJ0eSIsImdldFRpdGxlIiwicmVuZGVyV2lkdGgiLCJpZCIsIm5hbWUiLCJwcm9tcHQiLCJ3aWR0aCIsInJvd0xpc3QiLCJjb2xSYXRpbyIsImZvckVhY2giLCJNYXRoIiwiZmxvb3IiLCJlYWNoVHJlZSIsInJvdyIsInJvd0luZGV4IiwiaXRlbXMiLCJwYXRoIiwicGFyZW50Iiwibm9kZXMiLCJpdGVtIiwiY29sdW1uSW5kZXgiLCJjZWxsVmFsdWUiLCJpc0luZGV4IiwiaW5kZXhNZXRob2QiLCJnZXQiLCJ0cmVlTm9kZSIsInJlcGVhdCIsImxlbmd0aCIsImluZGVudCIsInB1c2giLCJmb290ZXJEYXRhIiwiZm9vdGVycyIsImZpbHRlciIsInJvd3MiLCJnZXRDb2x1bW5JbmRleCIsImRvYyIsImpzUERGIiwicHV0T25seVVzZWRGb250cyIsIm9yaWVudGF0aW9uIiwidGFibGUiLCJjb25jYXQiLCJwcmludEhlYWRlcnMiLCJhdXRvU2l6ZSIsInNhdmUiLCIkWE1vZGFsIiwiaTE4biIsInN0YXR1cyIsImhhbmRsZUV4cG9ydEV2ZW50IiwiVlhFVGFibGVQbHVnaW5FeHBvcnRQREYiLCJpbnN0YWxsIiwieHRhYmxlIiwiT2JqZWN0IiwiYXNzaWduIiwidHlwZXMiLCJwZGYiLCJpbnRlcmNlcHRvciIsIm1peGluIiwidCIsImtleSIsIndpbmRv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QUEzQixFQUFzQztBQUNwQyxNQUFJQSxNQUFNLENBQUNHLE9BQVAsQ0FBZUssSUFBZixLQUF3QixLQUE1QixFQUFtQztBQUNqQ1QsSUFBQUEsU0FBUyxDQUFDQyxNQUFELENBQVQ7QUFDQSxXQUFPLEtBQVA7QUFDRDtBQUNGO0FBRUQ7Ozs7O0FBR08sSUFBTXdFLHVCQUF1QixHQUFRO0FBQzFDQyxFQUFBQSxPQUQwQyxtQkFDbENDLE1BRGtDLEVBQ1g7QUFDN0JDLElBQUFBLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjRixNQUFNLENBQUNHLEtBQXJCLEVBQTRCO0FBQUVDLE1BQUFBLEdBQUcsRUFBRTtBQUFQLEtBQTVCO0FBQ0FKLElBQUFBLE1BQU0sQ0FBQ0ssV0FBUCxDQUFtQkMsS0FBbkIsQ0FBeUI7QUFDdkIsc0JBQWdCVDtBQURPLEtBQXpCO0FBR0FDLElBQUFBLHVCQUF1QixDQUFDUyxDQUF4QixHQUE0QlAsTUFBTSxDQUFDTyxDQUFuQztBQUNEO0FBUHlDLENBQXJDOzs7QUFVUCxTQUFTWixJQUFULENBQWNhLEdBQWQsRUFBeUI7QUFDdkIsTUFBSVYsdUJBQXVCLENBQUNTLENBQTVCLEVBQStCO0FBQzdCLFdBQU9ULHVCQUF1QixDQUFDUyxDQUF4QixDQUEwQkMsR0FBMUIsQ0FBUDtBQUNEO0FBQ0Y7O0FBRUQsSUFBSSxPQUFPQyxNQUFQLEtBQWtCLFdBQWxCLElBQWlDQSxNQUFNLENBQUNDLFFBQTVDLEVBQXNEO0FBQ3BERCxFQUFBQSxNQUFNLENBQUNDLFFBQVAsQ0FBZ0JDLEdBQWhCLENBQW9CYix1QkFBcEI7QUFDRDs7ZUFFY0EsdUIiLCJmaWxlIjoiaW5kZXguY29tbW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFhFVXRpbHMgZnJvbSAneGUtdXRpbHMvbWV0aG9kcy94ZS11dGlscydcclxuaW1wb3J0IFZYRVRhYmxlIGZyb20gJ3Z4ZS10YWJsZS9saWIvdnhlLXRhYmxlJ1xyXG5pbXBvcnQganNQREYgZnJvbSAnanNwZGYnXHJcblxyXG5mdW5jdGlvbiBleHBvcnRQREYocGFyYW1zOiBhbnkpIHtcclxuICBsZXQgY29sV2lkdGg6IG51bWJlciA9IDBcclxuICBjb25zdCB7ICR0YWJsZSwgb3B0aW9ucywgY29sdW1ucywgZGF0YXMgfSA9IHBhcmFtc1xyXG4gIGNvbnN0IHsgdHJlZUNvbmZpZywgdGFibGVGdWxsRGF0YSB9ID0gJHRhYmxlXHJcbiAgY29uc3QgeyB0eXBlLCBmaWxlbmFtZSwgaXNIZWFkZXIsIGlzRm9vdGVyLCBvcmlnaW5hbCwgZGF0YSwgbWVzc2FnZSwgZm9vdGVyRmlsdGVyTWV0aG9kIH0gPSBvcHRpb25zXHJcbiAgY29uc3QgY29sSGVhZDogYW55ID0ge31cclxuICBjb25zdCBmb290TGlzdDogYW55W10gPSBbXVxyXG4gIGNvbnN0IGhlYWRlcnM6IGFueVtdID0gY29sdW1ucy5tYXAoKGNvbHVtbjogYW55KSA9PiB7XHJcbiAgICBjb25zdCB0aXRsZTogc3RyaW5nID0gWEVVdGlscy50b1N0cmluZyhvcmlnaW5hbCA/IGNvbHVtbi5wcm9wZXJ0eSA6IGNvbHVtbi5nZXRUaXRsZSgpKSB8fCAnICdcclxuICAgIGNvbFdpZHRoICs9IGNvbHVtbi5yZW5kZXJXaWR0aFxyXG4gICAgaWYgKGlzSGVhZGVyKSB7XHJcbiAgICAgIGNvbEhlYWRbY29sdW1uLmlkXSA9IHRpdGxlXHJcbiAgICB9XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICBuYW1lOiBjb2x1bW4uaWQsXHJcbiAgICAgIHByb21wdDogdGl0bGUsXHJcbiAgICAgIHdpZHRoOiBjb2x1bW4ucmVuZGVyV2lkdGhcclxuICAgIH1cclxuICB9KVxyXG4gIGxldCByb3dMaXN0OiBhbnlbXSA9IFtdO1xyXG4gIGNvbnN0IGNvbFJhdGlvID0gY29sV2lkdGggLyAxMDBcclxuICBoZWFkZXJzLmZvckVhY2goKGNvbHVtbjogYW55KSA9PiB7XHJcbiAgICBjb2x1bW4ud2lkdGggPSBNYXRoLmZsb29yKGNvbHVtbi53aWR0aCAvIGNvbFJhdGlvICogNCkgLSAxXHJcbiAgfSlcclxuICBpZiAodHJlZUNvbmZpZykge1xyXG4gICAgWEVVdGlscy5lYWNoVHJlZShkYXRhID8gZGF0YXMgOiB0YWJsZUZ1bGxEYXRhLCAocm93OiBhbnksIHJvd0luZGV4OiBudW1iZXIsIGl0ZW1zOiBhbnksIHBhdGg6IGFueVtdLCBwYXJlbnQ6IGFueSwgbm9kZXM6IGFueVtdKSA9PiB7XHJcbiAgICAgIGNvbnN0IGl0ZW06IGFueSA9IHt9XHJcbiAgICAgIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uOiBhbnksIGNvbHVtbkluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgICBsZXQgY2VsbFZhbHVlXHJcbiAgICAgICAgY29uc3QgcHJvcGVydHkgPSBjb2x1bW4ucHJvcGVydHlcclxuICAgICAgICBjb25zdCBpc0luZGV4ID0gY29sdW1uLnR5cGUgPT09ICdpbmRleCdcclxuICAgICAgICBpZiAoIW9yaWdpbmFsIHx8IGlzSW5kZXgpIHtcclxuICAgICAgICAgIGNlbGxWYWx1ZSA9IGlzSW5kZXggPyAoY29sdW1uLmluZGV4TWV0aG9kID8gY29sdW1uLmluZGV4TWV0aG9kKHsgcm93LCByb3dJbmRleCwgY29sdW1uLCBjb2x1bW5JbmRleCB9KSA6IHJvd0luZGV4ICsgMSkgOiByb3dbY29sdW1uLmlkXVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBjZWxsVmFsdWUgPSBYRVV0aWxzLmdldChyb3csIHByb3BlcnR5KVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodHJlZUNvbmZpZyAmJiBjb2x1bW4udHJlZU5vZGUpIHtcclxuICAgICAgICAgIGNlbGxWYWx1ZSA9ICcgJy5yZXBlYXQoKG5vZGVzLmxlbmd0aCAtIDEpICogKHRyZWVDb25maWcuaW5kZW50IHx8IDE2KSAvIDgpICsgY2VsbFZhbHVlXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGl0ZW1bY29sdW1uLmlkXSA9IFhFVXRpbHMudG9TdHJpbmcoY2VsbFZhbHVlKSB8fCAnICdcclxuICAgICAgfSlcclxuICAgICAgcm93TGlzdC5wdXNoKGl0ZW0pXHJcbiAgICB9KVxyXG4gIH0gZWxzZSB7XHJcbiAgICBkYXRhcy5mb3JFYWNoKChyb3c6IGFueSwgcm93SW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgICBjb25zdCBpdGVtOiBhbnkgPSB7fVxyXG4gICAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbjogYW55LCBjb2x1bW5JbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgbGV0IGNlbGxWYWx1ZVxyXG4gICAgICAgIGNvbnN0IHByb3BlcnR5ID0gY29sdW1uLnByb3BlcnR5XHJcbiAgICAgICAgY29uc3QgaXNJbmRleCA9IGNvbHVtbi50eXBlID09PSAnaW5kZXgnXHJcbiAgICAgICAgaWYgKCFvcmlnaW5hbCB8fCBpc0luZGV4KSB7XHJcbiAgICAgICAgICBjZWxsVmFsdWUgPSBpc0luZGV4ID8gKGNvbHVtbi5pbmRleE1ldGhvZCA/IGNvbHVtbi5pbmRleE1ldGhvZCh7IHJvdywgcm93SW5kZXgsIGNvbHVtbiwgY29sdW1uSW5kZXggfSkgOiByb3dJbmRleCArIDEpIDogcm93W2NvbHVtbi5pZF1cclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgY2VsbFZhbHVlID0gWEVVdGlscy5nZXQocm93LCBwcm9wZXJ0eSlcclxuICAgICAgICB9XHJcbiAgICAgICAgaXRlbVtjb2x1bW4uaWRdID0gWEVVdGlscy50b1N0cmluZyhjZWxsVmFsdWUpIHx8ICcgJ1xyXG4gICAgICB9KVxyXG4gICAgICByb3dMaXN0LnB1c2goaXRlbSlcclxuICAgIH0pXHJcbiAgfVxyXG4gIGlmIChpc0Zvb3Rlcikge1xyXG4gICAgY29uc3QgZm9vdGVyRGF0YTogYW55W10gPSAkdGFibGUuZm9vdGVyRGF0YVxyXG4gICAgY29uc3QgZm9vdGVyczogYW55W10gPSBmb290ZXJGaWx0ZXJNZXRob2QgPyBmb290ZXJEYXRhLmZpbHRlcihmb290ZXJGaWx0ZXJNZXRob2QpIDogZm9vdGVyRGF0YVxyXG4gICAgZm9vdGVycy5mb3JFYWNoKChyb3dzOiBhbnlbXSkgPT4ge1xyXG4gICAgICBjb25zdCBpdGVtOiBhbnkgPSB7fVxyXG4gICAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbjogYW55KSA9PiB7XHJcbiAgICAgICAgaXRlbVtjb2x1bW4uaWRdID0gWEVVdGlscy50b1N0cmluZyhyb3dzWyR0YWJsZS5nZXRDb2x1bW5JbmRleChjb2x1bW4pXSkgfHwgJyAnXHJcbiAgICAgIH0pXHJcbiAgICAgIGZvb3RMaXN0LnB1c2goaXRlbSlcclxuICAgIH0pXHJcbiAgfVxyXG4gIC8vIOi9rOaNonBkZlxyXG4gIGNvbnN0IGRvYyA9IG5ldyBqc1BERih7IHB1dE9ubHlVc2VkRm9udHM6IHRydWUsIG9yaWVudGF0aW9uOiAnbGFuZHNjYXBlJyB9KTtcclxuICBkb2MudGFibGUoMSwgMSwgKGlzSGVhZGVyID8gW2NvbEhlYWRdIDogW10pLmNvbmNhdChyb3dMaXN0KS5jb25jYXQoZm9vdExpc3QpLCBoZWFkZXJzLCB7IHByaW50SGVhZGVyczogZmFsc2UsIGF1dG9TaXplOiBmYWxzZSB9KTtcclxuICBkb2Muc2F2ZShgJHtmaWxlbmFtZX0uJHt0eXBlfWApXHJcbiAgaWYgKG1lc3NhZ2UgIT09IGZhbHNlKSB7XHJcbiAgICAkdGFibGUuJFhNb2RhbC5tZXNzYWdlKHsgbWVzc2FnZTogaTE4bigndnhlLnRhYmxlLmV4cFN1Y2Nlc3MnKSwgc3RhdHVzOiAnc3VjY2VzcycgfSlcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUV4cG9ydEV2ZW50KHBhcmFtczogYW55KSB7XHJcbiAgaWYgKHBhcmFtcy5vcHRpb25zLnR5cGUgPT09ICdwZGYnKSB7XHJcbiAgICBleHBvcnRQREYocGFyYW1zKVxyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog5Z+65LqOIHZ4ZS10YWJsZSDooajmoLznmoTlop7lvLrmj5Lku7bvvIzmlK/mjIHlr7zlh7ogcGRmIOagvOW8j1xyXG4gKi9cclxuZXhwb3J0IGNvbnN0IFZYRVRhYmxlUGx1Z2luRXhwb3J0UERGOiBhbnkgPSB7XHJcbiAgaW5zdGFsbCh4dGFibGU6IHR5cGVvZiBWWEVUYWJsZSkge1xyXG4gICAgT2JqZWN0LmFzc2lnbih4dGFibGUudHlwZXMsIHsgcGRmOiAwIH0pXHJcbiAgICB4dGFibGUuaW50ZXJjZXB0b3IubWl4aW4oe1xyXG4gICAgICAnZXZlbnQuZXhwb3J0JzogaGFuZGxlRXhwb3J0RXZlbnRcclxuICAgIH0pXHJcbiAgICBWWEVUYWJsZVBsdWdpbkV4cG9ydFBERi50ID0geHRhYmxlLnRcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGkxOG4oa2V5OiBzdHJpbmcpIHtcclxuICBpZiAoVlhFVGFibGVQbHVnaW5FeHBvcnRQREYudCkge1xyXG4gICAgcmV0dXJuIFZYRVRhYmxlUGx1Z2luRXhwb3J0UERGLnQoa2V5KVxyXG4gIH1cclxufVxyXG5cclxuaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5WWEVUYWJsZSkge1xyXG4gIHdpbmRvdy5WWEVUYWJsZS51c2UoVlhFVGFibGVQbHVnaW5FeHBvcnRQREYpXHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IFZYRVRhYmxlUGx1Z2luRXhwb3J0UERGXHJcbiJdfQ==
